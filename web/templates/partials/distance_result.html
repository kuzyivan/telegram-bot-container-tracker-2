{% if error %}
<div class="bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-800 rounded-2xl p-6 text-center animate-shake">
    <div class="inline-flex items-center justify-center w-12 h-12 bg-red-100 dark:bg-red-800 rounded-full text-red-600 dark:text-red-300 mb-3">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
    </div>
    <h3 class="text-lg font-bold text-red-700 dark:text-red-400 mb-1">Не удалось рассчитать</h3>
    <p class="text-red-600 dark:text-red-300 text-sm">{{ error }}</p>
</div>

{% elif result %}
<div class="bg-white dark:bg-slate-800 rounded-3xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden animate-slide-up">
    
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-8 text-white text-center">
        <p class="text-blue-100 text-xs font-bold uppercase tracking-widest mb-2">Тарифное расстояние</p>
        <div class="flex items-baseline justify-center gap-2">
            <span class="text-5xl font-extrabold tracking-tight">{{ result.distance }}</span>
            <span class="text-2xl font-medium opacity-80">км</span>
        </div>
    </div>

    <div class="h-80 w-full bg-slate-100 dark:bg-slate-900 relative z-0" id="map-container">
        </div>

    <div class="p-6 md:p-8">
        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 7m0 13V7"></path></svg>
            Детализация маршрута
        </h3>

        <div class="space-y-4 relative">
            <div class="absolute left-[19px] top-3 bottom-3 w-0.5 bg-slate-200 dark:bg-slate-700"></div>

            <div class="relative flex gap-4">
                <div class="w-10 h-10 rounded-full bg-blue-50 dark:bg-blue-900/30 border-2 border-blue-500 flex items-center justify-center shrink-0 z-10">
                    <span class="text-blue-600 dark:text-blue-400 font-bold text-sm">A</span>
                </div>
                <div>
                    <p class="text-xs text-slate-500 dark:text-slate-400 uppercase font-bold mb-0.5">Отправление</p>
                    <h4 class="text-lg font-bold text-slate-900 dark:text-white leading-tight">{{ result.info_a.station_name }}</h4>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1 font-mono">Код: {{ result.info_a.station_code }} • {{ result.info_a.railway }}</p>
                </div>
            </div>

            {% set route = result.route_details %}
            
            {% if route.tpa_name != route.tpb_name %}
                <div class="relative flex gap-4">
                    <div class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center shrink-0 z-10">
                        <div class="w-2 h-2 rounded-full bg-slate-400"></div>
                    </div>
                    <div class="py-2">
                        <div class="text-sm font-medium text-slate-700 dark:text-slate-200 bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-lg inline-block">
                            Транзит: {{ route.tpa_name }} <span class="text-slate-400 mx-1">•</span> {{ route.distance_a_to_tpa }} км
                        </div>
                    </div>
                </div>
                
                {% if route.tpa_name != route.tpb_name and route.distance_tpa_to_tpb > 0 %}
                <div class="relative flex gap-4">
                    <div class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center shrink-0 z-10">
                        <div class="w-2 h-2 rounded-full bg-slate-400"></div>
                    </div>
                    <div class="py-2">
                        <div class="text-sm font-medium text-slate-700 dark:text-slate-200 bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-lg inline-block">
                            Транзит: {{ route.tpb_name }} <span class="text-slate-400 mx-1">•</span> {{ route.distance_tpa_to_tpb }} км
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endif %}

            <div class="relative flex gap-4">
                <div class="w-10 h-10 rounded-full bg-red-50 dark:bg-red-900/30 border-2 border-red-500 flex items-center justify-center shrink-0 z-10">
                    <span class="text-red-600 dark:text-red-400 font-bold text-sm">B</span>
                </div>
                <div>
                    <p class="text-xs text-slate-500 dark:text-slate-400 uppercase font-bold mb-0.5">Назначение</p>
                    <h4 class="text-lg font-bold text-slate-900 dark:text-white leading-tight">{{ result.info_b.station_name }}</h4>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1 font-mono">Код: {{ result.info_b.station_code }} • {{ result.info_b.railway }}</p>
                    
                    <div class="mt-2 text-sm text-slate-600 dark:text-slate-300">
                        Последний отрезок: <b>{{ route.distance_tpb_to_b }} км</b>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        if (typeof L === 'undefined') {
            console.error("Leaflet не загружен. Карта не будет отображена.");
            return;
        }

        const mapId = 'map-' + Math.random().toString(36).substr(2, 9);
        const container = document.getElementById('map-container');
        if (!container) return;

        container.innerHTML = `<div id="${mapId}" class="h-full w-full z-0" style="min-height: 350px;"></div>`;

        // --- Получаем маршрут с координатами из Python ---
        const pathWithCoords = {{ result.route_details.detailed_path_with_coords | tojson }};
        console.log(`Маршрут получен: ${pathWithCoords.length} точек с координатами.`);

        // Функция getCoords() больше не нужна.

        function initMap() {
            const map = L.map(mapId).setView([55.75, 37.61], 3);
            map.attributionControl.setPrefix(false);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 18
            }).addTo(map);

            const allLatLngs = pathWithCoords
                .filter(p => p.lat && p.lon)
                .map(p => [p.lat, p.lon]);

            if (allLatLngs.length === 0) {
                console.log("Нет координат для отображения маршрута.");
                return;
            }
            
            // --- Упрощение маркеров для отображения ---
            let pointsToDisplay = [];
            // Если точек мало, показываем все. Если много - прореживаем.
            const isDense = pathWithCoords.length > 20;
            const step = isDense ? Math.floor(pathWithCoords.length / 15) : 1;

            pathWithCoords.forEach((point, i) => {
                const isStart = i === 0;
                const isEnd = i === pathWithCoords.length - 1;
                if (isStart || isEnd || i % step === 0) {
                    pointsToDisplay.push({ ...point, type: isStart ? 'start' : (isEnd ? 'end' : 'transit') });
                }
            });
            console.log(`Будет отображено ${pointsToDisplay.length} маркеров.`);

            // --- Отрисовка маркеров ---
            pointsToDisplay.forEach(point => {
                if (!point.lat || !point.lon) return;

                const coords = [point.lat, point.lon];
                let iconColor = '#94a3b8', radius = 4, zIndex = 0;

                if (point.type === 'start') { iconColor = '#3b82f6'; radius = 7; zIndex = 100; }
                if (point.type === 'end')   { iconColor = '#ef4444'; radius = 7; zIndex = 100; }
                
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style='background-color: ${iconColor}; width: ${radius*2}px; height: ${radius*2}px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);'></div>`,
                    iconSize: [radius*2, radius*2],
                    iconAnchor: [radius, radius]
                });

                const marker = L.marker(coords, { icon: icon, zIndexOffset: zIndex }).addTo(map);
                if (point.type !== 'transit' || !isDense) {
                    marker.bindPopup(`<b>${point.name}</b>`);
                }
            });

            // --- Отрисовка линии и центрирование ---
            if (allLatLngs.length > 1) {
                L.polyline(allLatLngs, { color: '#3b82f6', weight: 4, opacity: 0.8, dashArray: '5, 10' }).addTo(map);
            }
            map.fitBounds(allLatLngs, { padding: [50, 50], maxZoom: 10, animate: true });
            
            setTimeout(() => map.invalidateSize(), 200);
        }

        setTimeout(initMap, 100);
    })();
</script>
{% endif %}