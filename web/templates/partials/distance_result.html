{% if error %}
<div class="bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-800 rounded-2xl p-6 text-center animate-shake">
    <div class="inline-flex items-center justify-center w-12 h-12 bg-red-100 dark:bg-red-800 rounded-full text-red-600 dark:text-red-300 mb-3">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
    </div>
    <h3 class="text-lg font-bold text-red-700 dark:text-red-400 mb-1">–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å</h3>
    <p class="text-red-600 dark:text-red-300 text-sm">{{ error }}</p>
</div>

{% elif result %}
<div class="bg-white dark:bg-slate-800 rounded-3xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden animate-slide-up">
    
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-8 text-white text-center">
        <p class="text-blue-100 text-xs font-bold uppercase tracking-widest mb-2">–¢–∞—Ä–∏—Ñ–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ</p>
        <div class="flex items-baseline justify-center gap-2">
            <span class="text-5xl font-extrabold tracking-tight">{{ result.distance }}</span>
            <span class="text-2xl font-medium opacity-80">–∫–º</span>
        </div>
    </div>

    <div class="h-80 w-full bg-slate-100 dark:bg-slate-900 relative z-0" id="map-container">
        </div>

    <div class="p-6 md:p-8">
        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 7m0 13V7"></path></svg>
            –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
        </h3>

        <div class="space-y-4 relative">
            <div class="absolute left-[19px] top-3 bottom-3 w-0.5 bg-slate-200 dark:bg-slate-700"></div>

            <div class="relative flex gap-4">
                <div class="w-10 h-10 rounded-full bg-blue-50 dark:bg-blue-900/30 border-2 border-blue-500 flex items-center justify-center shrink-0 z-10">
                    <span class="text-blue-600 dark:text-blue-400 font-bold text-sm">A</span>
                </div>
                <div>
                    <p class="text-xs text-slate-500 dark:text-slate-400 uppercase font-bold mb-0.5">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</p>
                    <h4 class="text-lg font-bold text-slate-900 dark:text-white leading-tight">{{ result.info_a.station_name }}</h4>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1 font-mono">–ö–æ–¥: {{ result.info_a.station_code }} ‚Ä¢ {{ result.info_a.railway }}</p>
                </div>
            </div>

            {% set route = result.route_details %}
            
            {% if route.tpa_name != route.tpb_name %}
                <div class="relative flex gap-4">
                    <div class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center shrink-0 z-10">
                        <div class="w-2 h-2 rounded-full bg-slate-400"></div>
                    </div>
                    <div class="py-2">
                        <div class="text-sm font-medium text-slate-700 dark:text-slate-200 bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-lg inline-block">
                            –¢—Ä–∞–Ω–∑–∏—Ç: {{ route.tpa_name }} <span class="text-slate-400 mx-1">‚Ä¢</span> {{ route.distance_a_to_tpa }} –∫–º
                        </div>
                    </div>
                </div>
                
                {% if route.tpa_name != route.tpb_name and route.distance_tpa_to_tpb > 0 %}
                <div class="relative flex gap-4">
                    <div class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center shrink-0 z-10">
                        <div class="w-2 h-2 rounded-full bg-slate-400"></div>
                    </div>
                    <div class="py-2">
                        <div class="text-sm font-medium text-slate-700 dark:text-slate-200 bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-lg inline-block">
                            –¢—Ä–∞–Ω–∑–∏—Ç: {{ route.tpb_name }} <span class="text-slate-400 mx-1">‚Ä¢</span> {{ route.distance_tpa_to_tpb }} –∫–º
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endif %}

            <div class="relative flex gap-4">
                <div class="w-10 h-10 rounded-full bg-red-50 dark:bg-red-900/30 border-2 border-red-500 flex items-center justify-center shrink-0 z-10">
                    <span class="text-red-600 dark:text-red-400 font-bold text-sm">B</span>
                </div>
                <div>
                    <p class="text-xs text-slate-500 dark:text-slate-400 uppercase font-bold mb-0.5">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</p>
                    <h4 class="text-lg font-bold text-slate-900 dark:text-white leading-tight">{{ result.info_b.station_name }}</h4>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1 font-mono">–ö–æ–¥: {{ result.info_b.station_code }} ‚Ä¢ {{ result.info_b.railway }}</p>
                    
                    <div class="mt-2 text-sm text-slate-600 dark:text-slate-300">
                        –ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç—Ä–µ–∑–æ–∫: <b>{{ route.distance_tpb_to_b }} –∫–º</b>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        console.log("–ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –∫–∞—Ä—Ç—ã...");
        const mapId = 'map-' + Math.random().toString(36).substr(2, 9);
        const container = document.getElementById('map-container');
        
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–º–µ–µ—Ç –≤—ã—Å–æ—Ç—É
        container.innerHTML = `<div id="${mapId}" class="h-full w-full z-0" style="min-height: 350px;"></div>`;

        // üî• –í–ê–ñ–ù–û: –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω—Ü–∏–π –∏–∑ Python
        // | tojson –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç Python-—Å–ø–∏—Å–æ–∫ ['–°—Ç1', '–°—Ç2'] –≤ JS-–º–∞—Å—Å–∏–≤ ["–°—Ç1", "–°—Ç2"]
        const pathData = {{ result.route_details.detailed_path | tojson }};
        const stationStart = "{{ result.info_a.station_name }}";
        const stationEnd = "{{ result.info_b.station_name }}";

        console.log("–ú–∞—Ä—à—Ä—É—Ç —Ç–æ—á–µ–∫:", pathData.length);

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        async function getCoords(query) {
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º countrycodes=ru, —á—Ç–æ–±—ã –Ω–µ –∏—Å–∫–∞—Ç—å –ë–µ–ª–æ–≥–æ—Ä—Å–∫ –≤ –ö—Ä—ã–º—É (ua/ru dispute) –∏–ª–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü–µ–π
                // –î–æ–±–∞–≤–ª—è–µ–º railway station —è–≤–Ω–æ
                let url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ' railway station')}&countrycodes=ru&limit=1`;
                let res = await fetch(url, { headers: { 'User-Agent': 'LogistrailApp/1.0' } });
                let data = await res.json();
                
                if (data.length > 0) return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                
                // Fallback: –ø—Ä–æ–±—É–µ–º –±–µ–∑ "railway station", –Ω–æ –≤—Å–µ –µ—â–µ –≤ –†–æ—Å—Å–∏–∏
                url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=ru&limit=1`;
                res = await fetch(url, { headers: { 'User-Agent': 'LogistrailApp/1.0' } });
                data = await res.json();
                
                return (data.length > 0) ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
            } catch (e) {
                console.error("Geo error:", e);
                return null;
            }
        }

        async function initMap() {
            if (typeof L === 'undefined') return;

            const map = L.map(mapId).setView([55.75, 37.61], 3);
            map.attributionControl.setPrefix(false);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 18
            }).addTo(map);

            const latLngs = [];
            
            // –ß—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å Nominatim –∏ –Ω–µ –∂–¥–∞—Ç—å –≤–µ—á–Ω–æ—Å—Ç—å, –±–µ—Ä–µ–º –Ω–µ –∫–∞–∂–¥—É—é —Ç–æ—á–∫—É,
            // –∞ –ø—Ä–æ—Ä–µ–∂–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤.
            // –í—Å–µ–≥–¥–∞ –±–µ—Ä–µ–º: –ø–µ—Ä–≤—É—é, –ø–æ—Å–ª–µ–¥–Ω—é—é, –∏ –∫–∞–∂–¥—É—é 5-—é –º–µ–∂–¥—É –Ω–∏–º–∏.
            const pointsToProcess = [];
            
            for (let i = 0; i < pathData.length; i++) {
                if (i === 0 || i === pathData.length - 1 || i % 5 === 0) {
                    pointsToProcess.push({
                        name: pathData[i],
                        type: (i === 0) ? 'start' : (i === pathData.length - 1) ? 'end' : 'transit'
                    });
                }
            }

            console.log("–ë—É–¥–µ–º –∏—Å–∫–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è " + pointsToProcess.length + " —Ç–æ—á–µ–∫");

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ—á–∫–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
            for (let point of pointsToProcess) {
                const coords = await getCoords(point.name);
                if (coords) {
                    latLngs.push(coords);
                    
                    let iconColor = '#94a3b8'; // –°–µ—Ä—ã–π –¥–ª—è —Ç—Ä–∞–Ω–∑–∏—Ç–∞
                    let zIndex = 0;
                    let radius = 4;

                    if (point.type === 'start') { iconColor = '#3b82f6'; zIndex = 100; radius = 7; } // –°–∏–Ω–∏–π
                    if (point.type === 'end')   { iconColor = '#ef4444'; zIndex = 100; radius = 7; } // –ö—Ä–∞—Å–Ω—ã–π

                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style='background-color: ${iconColor}; width: ${radius*2}px; height: ${radius*2}px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);'></div>`,
                        iconSize: [radius*2, radius*2],
                        iconAnchor: [radius, radius]
                    });

                    // –ú–∞—Ä–∫–µ—Ä—ã —Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∞—á–∞–ª–∞, –∫–æ–Ω—Ü–∞ –∏ –≤–∞–∂–Ω—ã—Ö —É–∑–ª–æ–≤, 
                    // —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –∫–∞—Ä—Ç—É —Å–æ—Ç–Ω–µ–π —Ç–æ—á–µ–∫
                    if (point.type !== 'transit' || pathData.length < 15) {
                         L.marker(coords, {icon: icon, zIndexOffset: zIndex})
                        .addTo(map)
                        .bindPopup(`<b>${point.name}</b>`);
                    } else {
                        // –î–ª—è —Ç—Ä–∞–Ω–∑–∏—Ç–Ω—ã—Ö –ø—Ä–æ—Å—Ç–æ –º–∞–ª–µ–Ω—å–∫–∏–µ –∫—Ä—É–∂–æ—á–∫–∏ –±–µ–∑ –ø–æ–ø–∞–ø–æ–≤ (–∏–ª–∏ –≤–æ–æ–±—â–µ –±–µ–∑ –º–∞—Ä–∫–µ—Ä–æ–≤, —Ç–æ–ª—å–∫–æ –ª–∏–Ω–∏—è)
                        L.circleMarker(coords, {
                            radius: 3,
                            color: 'white',
                            weight: 1,
                            fillColor: '#64748b',
                            fillOpacity: 0.8
                        }).addTo(map);
                    }
                }
            }

            if (latLngs.length > 0) {
                // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é —á–µ—Ä–µ–∑ –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏
                if (latLngs.length > 1) {
                    L.polyline(latLngs, { color: '#3b82f6', weight: 4, opacity: 0.8, dashArray: '5, 10' }).addTo(map);
                }
                map.fitBounds(latLngs, { padding: [50, 50], maxZoom: 10 });
            }
            
            setTimeout(() => map.invalidateSize(), 200);
        }

        setTimeout(initMap, 100);
    })();
</script>
{% endif %}