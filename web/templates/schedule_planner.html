{% extends "base.html" %}

{% block title %}–ì—Ä–∞—Ñ–∏–∫ –ø–æ–µ–∑–¥–æ–≤ ‚Äî Logistrail{% endblock %}

{% block content %}
<div class="space-y-6 pb-10 animate-fade-in">

    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-slate-900">–ì—Ä–∞—Ñ–∏–∫ –ø–æ–µ–∑–¥–æ–≤</h1>
            <p class="text-slate-500">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤.</p>
        </div>
        
        <div class="flex items-center gap-4">
            <button onclick="openShareModal()" class="flex items-center gap-2 bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 px-3 py-2 rounded-lg text-sm font-bold transition shadow-sm">
                <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
            </button>

            <div class="text-sm text-slate-500 flex items-center gap-2 border-l border-slate-300 pl-4">
                <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ
            </div>
        </div>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
        <div id='calendar' class="min-h-[600px]"></div>
    </div>

</div>

<div id="eventModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="modal-title">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∞</h3>
                
                <form id="createEventForm" class="space-y-4">
                    <input type="hidden" id="eventDate" name="date_str">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">–°–µ—Ä–≤–∏—Å –ø–æ–µ–∑–¥–∞ *</label>
                        <input type="text" name="service" id="inpService" required placeholder="FESCO Moscow Shuttle" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">–°—Ç–∞–Ω—Ü–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è *</label>
                        <input type="text" name="destination" id="inpDest" required placeholder="–°–∏–ª–∏–∫–∞—Ç–Ω–∞—è" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–°—Ç–æ–∫</label>
                            <input type="text" name="stock" id="inpStock" placeholder="20 x 40'HC" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫</label>
                            <input type="text" name="owner" id="inpOwner" placeholder="–¢—Ä–∞–Ω—Å–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="submitCreate()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button id="btnDelete" type="button" onclick="deleteEvent()" class="hidden mt-3 w-full inline-flex justify-center rounded-md border border-red-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-red-600 hover:bg-red-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<div id="shareModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeShareModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –ø–æ —Å—Å—ã–ª–∫–µ</h3>
                
                <div class="flex gap-2 mb-6">
                    <input type="text" id="newLinkName" placeholder="–ö–æ–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–∞—Ä—Ç–Ω–µ—Ä—ã)" class="flex-1 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <button onclick="createLink()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-medium text-sm">–°–æ–∑–¥–∞—Ç—å</button>
                </div>

                <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">–ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Å—ã–ª–∫–∏</h4>
                <div class="space-y-3 max-h-60 overflow-y-auto" id="linksList">
                    <p class="text-sm text-gray-500 text-center py-2">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-end">
                <button onclick="closeShareModal()" class="inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:text-sm">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
    let calendar;
    let selectedEventId = null;

    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ru',
            firstDay: 1,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,dayGridWeek'
            },
            editable: true,
            selectable: true,
            events: '/admin/api/schedule/events', 

            dateClick: function(info) {
                openModalForCreate(info.dateStr);
            },

            eventClick: function(info) {
                openModalForView(info.event);
            },

            eventDrop: function(info) {
                updateEventDate(info.event.id, info.event.start);
            },
            
            eventContent: function(arg) {
                let props = arg.event.extendedProps;
                let html = `<div class="flex flex-col gap-0.5 leading-tight py-1 px-1">`;
                html += `<div class="text-xs font-extrabold text-slate-800 truncate" title="–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ">üìç ${props.dest}</div>`;
                html += `<div class="text-[10px] font-bold text-blue-700 truncate" title="–°–µ—Ä–≤–∏—Å">üöÜ ${props.service}</div>`;
                if (props.stock) {
                    html += `<div class="text-[10px] text-slate-600 truncate border-t border-slate-100 mt-0.5 pt-0.5">üì¶ ${props.stock}</div>`;
                }
                if (props.owner) {
                    html += `<div class="text-[10px] text-slate-500 italic truncate">üë§ ${props.owner}</div>`;
                }
                html += `</div>`;
                return { html: html }
            }
        });
        
        calendar.render();
    });

    // --- –§—É–Ω–∫—Ü–∏–∏ –ú–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–°–æ–±—ã—Ç–∏—è) ---

    function openModalForCreate(dateStr) {
        selectedEventId = null;
        document.getElementById('modal-title').innerText = "–ü–ª–∞–Ω –Ω–∞ " + dateStr;
        document.getElementById('eventDate').value = dateStr;
        document.getElementById('createEventForm').reset();
        document.getElementById('btnDelete').classList.add('hidden'); 
        document.getElementById('eventModal').classList.remove('hidden');
    }

    function openModalForView(event) {
        selectedEventId = event.id;
        let props = event.extendedProps;
        document.getElementById('modal-title').innerText = "–ü–æ–µ–∑–¥: " + props.service;
        document.getElementById('eventDate').value = event.startStr;
        document.getElementById('inpService').value = props.service;
        document.getElementById('inpDest').value = props.dest;
        document.getElementById('inpStock').value = props.stock;
        document.getElementById('inpOwner').value = props.owner;
        document.getElementById('btnDelete').classList.remove('hidden');
        document.getElementById('eventModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('eventModal').classList.add('hidden');
    }

    async function submitCreate() {
        if (selectedEventId) {
            await deleteEvent(true); 
        }
        const form = document.getElementById('createEventForm');
        const formData = new FormData(form);
        try {
            let response = await fetch('/admin/api/schedule/create', { method: 'POST', body: formData });
            if (response.ok) {
                closeModal();
                calendar.refetchEvents();
            } else { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); }
        } catch (e) { console.error(e); }
    }

    async function updateEventDate(id, newDate) {
        const dateStr = newDate.toISOString().split('T')[0];
        const formData = new FormData();
        formData.append('new_date', dateStr);
        try {
            let response = await fetch(`/admin/api/schedule/${id}/move`, { method: 'POST', body: formData });
            if (!response.ok) {
                alert("–û—à–∏–±–∫–∞");
                calendar.refetchEvents();
            }
        } catch (e) { console.error(e); }
    }

    async function deleteEvent(silent = false) {
        if (!selectedEventId) return;
        if (!silent && !confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
        try {
            let response = await fetch(`/admin/api/schedule/${selectedEventId}`, { method: 'DELETE' });
            if (response.ok) {
                if(!silent) {
                    closeModal();
                    calendar.refetchEvents();
                }
            }
        } catch (e) { console.error(e); }
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –ú–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–®–µ—Ä–∏–Ω–≥) ---

    function openShareModal() {
        document.getElementById('shareModal').classList.remove('hidden');
        loadLinks();
    }

    function closeShareModal() {
        document.getElementById('shareModal').classList.add('hidden');
    }

    async function loadLinks() {
        const list = document.getElementById('linksList');
        try {
            let res = await fetch('/admin/api/schedule/links');
            let links = await res.json();
            
            if (links.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-400 text-center">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Å—ã–ª–æ–∫.</p>';
                return;
            }

            let html = '';
            links.forEach(link => {
                const fullUrl = window.location.origin + `/schedule/share/${link.token}`;
                html += `
                    <div class="flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-100 mb-2">
                        <div class="overflow-hidden mr-3 w-full">
                            <p class="text-sm font-bold text-slate-800">${link.name}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="text" readonly value="${fullUrl}" class="text-xs text-slate-500 bg-white border border-slate-200 rounded px-2 py-1 w-full focus:outline-none" onclick="this.select()">
                                <a href="${fullUrl}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                </a>
                            </div>
                        </div>
                        <button onclick="deleteLink(${link.id})" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
            });
            list.innerHTML = html;
        } catch (e) { console.error(e); }
    }

    async function createLink() {
        const nameInput = document.getElementById('newLinkName');
        const name = nameInput.value.trim();
        if (!name) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ");

        const formData = new FormData();
        formData.append('name', name);

        try {
            let res = await fetch('/admin/api/schedule/links/create', { method: 'POST', body: formData });
            if (res.ok) {
                nameInput.value = '';
                loadLinks();
            }
        } catch (e) { console.error(e); }
    }

    async function deleteLink(id) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å—Å—ã–ª–∫—É? –î–æ—Å—Ç—É–ø –ø–æ –Ω–µ–π –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç.")) return;
        try {
            let res = await fetch(`/admin/api/schedule/links/${id}`, { method: 'DELETE' });
            if (res.ok) loadLinks();
        } catch (e) { console.error(e); }
    }
</script>

<style>
    .fc-event {
        background-color: #ffffff !important;
        border: 1px solid #e2e8f0 !important;
        border-left: 3px solid #3b82f6 !important;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        cursor: pointer;
        margin-bottom: 2px !important;
        transition: transform 0.1s, box-shadow 0.1s;
    }
    .fc-event:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 5;
    }
    .fc-daygrid-event { white-space: normal !important; align-items: flex-start; }
    .fc-daygrid-event-dot { display: none; } 
    .fc-event-main { width: 100%; padding: 0; }
    .fc-toolbar-title { font-size: 1.5rem !important; text-transform: capitalize; font-weight: 700; color: #1e293b; }
    .fc-button { background-color: white !important; color: #475569 !important; border: 1px solid #e2e8f0 !important; text-transform: capitalize; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    .fc-button:hover { background-color: #f8fafc !important; }
    .fc-button-active { background-color: #eff6ff !important; color: #2563eb !important; border-color: #bfdbfe !important; }
    .fc-col-header-cell-cushion { text-transform: uppercase; font-size: 0.75rem; font-weight: 700; color: #64748b; padding-top: 10px !important; padding-bottom: 10px !important; }
    .fc-daygrid-day-number { color: #334155; font-weight: 500; padding: 8px !important; }
    .fc-day-today { background-color: #f8fafc !important; }
</style>
{% endblock %}