{% extends "base.html" %}

{% block title %}График поездов — Logistrail{% endblock %}

{% block content %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<div class="max-w-7xl mx-auto space-y-6 pb-12 animate-fade-in">

    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h1 class="text-3xl font-bold text-mono-black tracking-tight">График отправки</h1>
            <p class="text-sm text-mono-gray mt-1">Планирование сервисов и стоков</p>
        </div>
        
        <div class="flex items-center gap-4">
            <button onclick="openShareModal()" class="flex items-center gap-2 bg-white border border-mono-border text-mono-black hover:bg-mono-bg px-4 py-2 rounded-xl text-sm font-bold transition shadow-sm">
                <svg class="w-4 h-4 text-mono-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                Поделиться
            </button>
        </div>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
        <div id='calendar' class="min-h-[700px] font-sans"></div>
    </div>

</div>

<style>
    /* Переопределение переменных FullCalendar */
    :root {
        --fc-border-color: #E5E5EA;
        --fc-button-text-color: #111111;
        --fc-button-bg-color: #FFFFFF;
        --fc-button-border-color: #E5E5EA;
        --fc-button-hover-bg-color: #F5F5F7;
        --fc-button-hover-border-color: #E5E5EA;
        --fc-button-active-bg-color: #111111;
        --fc-button-active-border-color: #111111;
        --fc-button-active-text-color: #FFFFFF;
        --fc-today-bg-color: #F9FAFB;
    }
    .fc-col-header-cell-cushion { color: #8E8E93; text-transform: uppercase; font-size: 0.7rem; font-weight: 700; padding: 12px !important; }
    .fc-daygrid-day-number { color: #111111; font-weight: 600; padding: 8px !important; }
    .fc-button { border-radius: 10px !important; font-weight: 600 !important; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .fc-toolbar-title { font-size: 1.25rem !important; font-weight: 700 !important; color: #111111; }
    .fc-event { border: none !important; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-radius: 6px; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        
        if (!calendarEl) return;

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ru',
            firstDay: 1,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,dayGridWeek'
            },
            buttonText: { today: 'Сегодня', month: 'Месяц', week: 'Неделя' },
            events: '/admin/api/schedule/events', 
            editable: true,
            selectable: true,

            // Клик по дате - создание
            dateClick: function(info) {
                // Здесь вызов твоей модалки создания (код модалки должен быть ниже)
                // openModalForCreate(info.dateStr); 
                alert('Клик по дате: ' + info.dateStr); // Заглушка для теста
            },

            // Клик по событию
            eventClick: function(info) {
                // openModalForView(info.event);
                alert('Клик по событию: ' + info.event.title); // Заглушка
            },

            // Рендер карточки события (Безопасный)
            eventContent: function(arg) {
                let props = arg.event.extendedProps || {}; // Защита от undefined
                let bgColor = arg.event.backgroundColor || '#111111';
                
                let dest = props.dest || arg.event.title;
                let service = props.service || 'Сервис';
                let stock = props.stock || '';

                let html = `
                    <div class="flex flex-col py-1.5 px-2 overflow-hidden bg-white h-full border border-mono-border rounded-md" style="border-left: 3px solid ${bgColor};">
                        <div class="text-xs font-bold text-mono-black truncate mb-0.5 leading-tight">
                            ${dest}
                        </div>
                        <div class="text-[10px] text-mono-gray truncate leading-tight">
                            ${service}
                        </div>
                        ${stock ? `<div class="text-[9px] text-mono-gray/70 truncate mt-1 pt-1 border-t border-mono-light">${stock}</div>` : ''}
                    </div>
                `;
                return { html: html }
            }
        });
        
        calendar.render();
    });
</script>

{% endblock %}