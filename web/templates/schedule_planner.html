<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Планировщик Расписания Поездов</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom styles for the calendar */
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .fc-toolbar-title { font-size: 1.5rem !important; font-weight: 600 !important; color: #1f2937; }
        .fc-daygrid-event {
            border-radius: 0.5rem;
            padding: 4px 8px;
            margin-bottom: 2px;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: normal;
            line-height: 1.3;
        }
        .fc-daygrid-day-number {
            font-weight: 600;
        }
        .modal {
            transition: opacity 0.2s ease-in-out;
        }
        .modal-active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-inactive {
            opacity: 0;
            pointer-events: none;
        }
        .stock-tag {
            display: inline-block;
            background-color: #e0f2f1; /* Light teal */
            color: #0d9488; /* Dark teal */
            padding: 2px 8px;
            border-radius: 0.5rem;
            margin: 2px;
            font-size: 0.75rem;
        }
        .direction-block {
            border: 1px solid #d1d5db;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            background-color: #ffffff;
        }
        .teu-label {
             font-weight: 700;
             color: #059669; /* Green */
        }
    </style>
    <!-- FullCalendar JS & CSS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales-all.global.min.js'></script>
</head>
<body class="p-4 sm:p-8">

    <div id='calendar' class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg"></div>

    <!-- Модальное окно создания/редактирования поезда -->
    <div id="trainModal" class="modal modal-inactive fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" onclick="closeModal(event)">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl transform transition-all duration-300" onclick="event.stopPropagation()">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-gray-800">Создать Новый Поезд</h2>
            
            <form id="trainForm" method="POST">
                <input type="hidden" id="eventDate" name="date_str">
                <input type="hidden" id="eventId" name="event_id">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="col-span-1">
                        <label for="service" class="block text-sm font-medium text-gray-700">Номер/Имя Сервиса (Обязательно)</label>
                        <input type="text" id="service" name="service" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div class="col-span-1">
                        <label for="color" class="block text-sm font-medium text-gray-700">Цвет на графике</label>
                        <input type="color" id="color" name="color" value="#111111" class="mt-1 block w-full h-10 rounded-lg border-gray-300 shadow-sm">
                    </div>
                    
                    <!-- Destination (для совместимости, может быть скрыт, если используется многонаправленный ввод) -->
                    <div class="col-span-2 hidden">
                        <label for="destination" class="block text-sm font-medium text-gray-700">Основное Направление (для старого формата)</label>
                        <input type="text" id="destination" name="destination" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                </div>

                <!-- Блок динамического управления направлениями и стоками -->
                <div class="mb-4 bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Привязка Стоков по Направлениям</h3>
                    <div id="directionStockContainer">
                        <!-- Динамические блоки будут здесь -->
                    </div>
                    <button type="button" onclick="addDirectionBlock()" class="text-indigo-600 hover:text-indigo-800 font-medium mt-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Добавить Направление
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="owner" class="block text-sm font-medium text-gray-700">Собственник вагонов</label>
                        <input type="text" id="owner" name="owner" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="overload_station" class="block text-sm font-medium text-gray-700">Станция перегруза</label>
                        <input type="text" id="overload_station" name="overload_station" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div class="md:col-span-2">
                        <label for="comment" class="block text-sm font-medium text-gray-700">Комментарий</label>
                        <textarea id="comment" name="comment" rows="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>
                </div>
                
                <!-- Скрытое поле для JSON-строки стоков -->
                <input type="hidden" id="stockDataJson" name="stock">

                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium">Отмена</button>
                    <button type="submit" id="submitButton" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium transition duration-150">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно деталей/редактирования -->
    <div id="detailModal" class="modal modal-inactive fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" onclick="closeModal(event, 'detailModal')">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg transform transition-all duration-300" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold mb-4 text-gray-800" id="detailModalTitle">Детали Поезда</h2>
            
            <div id="detailDisplay" class="mb-4 space-y-3">
                <!-- Детали будут здесь -->
            </div>

            <div id="detailEditFormContainer" class="hidden">
                <form id="detailEditForm" class="space-y-4 mb-4" method="POST">
                    <input type="hidden" id="detailEventId" name="event_id">
                    
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Редактирование Стоков и Комментариев</h3>
                    
                    <!-- Блок динамического управления направлениями и стоками для редактирования -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-base font-medium mb-3 text-gray-700">Привязка Стоков по Направлениям</h4>
                        <div id="editDirectionStockContainer">
                            <!-- Динамические блоки будут здесь -->
                        </div>
                        <button type="button" onclick="addDirectionBlock('edit')" class="text-indigo-600 hover:text-indigo-800 font-medium mt-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            Добавить Направление
                        </button>
                    </div>

                    <div class="w-full">
                        <label for="editComment" class="block text-sm font-medium text-gray-700">Комментарий</label>
                        <textarea id="editComment" name="comment" rows="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>

                    <input type="hidden" id="editStockDataJson" name="stock">
                </form>
            </div>
            
            <div class="flex justify-between items-center pt-4 border-t">
                <button type="button" id="deleteButton" class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 font-medium transition duration-150 text-sm hidden">Удалить</button>
                <div class="flex space-x-3">
                    <button type="button" onclick="closeModal(null, 'detailModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium">Закрыть</button>
                    <button type="button" id="toggleEditButton" onclick="toggleEditMode()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-medium transition duration-150">Редактировать</button>
                    <button type="button" id="saveEditButton" onclick="submitEditForm()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium transition duration-150 hidden">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const calendarEl = document.getElementById('calendar');
            const stocksList = await fetchStocksList();
            const directions = [...new Set(stocksList.map(s => s.direction))]; // Уникальные направления

            const calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'ru',
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                editable: true,
                selectable: true,
                dayMaxEvents: true,
                events: {
                    // *** ИСПРАВЛЕНИЕ ОШИБКИ 404: добавлен префикс /admin ***
                    url: '/admin/api/schedule/events',
                    failure: function() {
                        console.error('Не удалось загрузить события. Проверьте путь: /admin/api/schedule/events');
                    }
                },
                
                // Обработчик нажатия на ячейку (для создания)
                select: function(info) {
                    openCreateModal(info.startStr);
                },

                // Обработчик нажатия на событие (для деталей/редактирования)
                eventClick: function(info) {
                    openDetailModal(info.event);
                },

                // Обработчик перетаскивания (только для админа)
                eventDrop: async function(info) {
                    const newDate = info.event.startStr.split('T')[0];
                    const eventId = info.event.id;
                    
                    const formData = new FormData();
                    formData.append('new_date', newDate);

                    try {
                        const response = await fetch(`/admin/api/schedule/${eventId}/move`, {
                            method: 'POST',
                            body: formData
                        });
                        const result = await response.json();
                        if (result.status !== 'ok') {
                            alert('Ошибка при перемещении поезда: ' + (result.detail || 'Неизвестная ошибка'));
                            info.revert(); // Откатить изменение на календаре
                        }
                    } catch (error) {
                        console.error('Move error:', error);
                        alert('Ошибка сети при перемещении.');
                        info.revert();
                    }
                }
            });

            calendar.render();

            // Привязка формы создания поезда
            document.getElementById('trainForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleSubmit(e.target, calendar, 'create');
            });
            
            window.calendarInstance = calendar; // Сохраняем экземпляр для доступа из функций
            window.stocksList = stocksList;
            window.uniqueDirections = directions;
            
            // Инициализация первого блока при открытии
            addDirectionBlock('create', true); 
        });

        // --- ГЛОБАЛЬНЫЕ ФУНКЦИИ МОДАЛЬНЫХ ОКОН ---

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('modal-inactive');
            document.getElementById(modalId).classList.add('modal-active');
        }

        function closeModal(event = null, modalId = 'trainModal') {
            if (event && event.target.id === modalId) {
                document.getElementById(modalId).classList.remove('modal-active');
                document.getElementById(modalId).classList.add('modal-inactive');
            } else if (!event) {
                document.getElementById(modalId).classList.remove('modal-active');
                document.getElementById(modalId).classList.add('modal-inactive');
            }
        }

        function openCreateModal(dateStr) {
            const modal = document.getElementById('trainModal');
            document.getElementById('modalTitle').textContent = 'Создать Поезд на ' + dateStr;
            document.getElementById('eventDate').value = dateStr;
            document.getElementById('eventId').value = '';
            document.getElementById('trainForm').reset();
            document.getElementById('submitButton').textContent = 'Сохранить';

            // Очистка и инициализация блока стоков/направлений
            const container = document.getElementById('directionStockContainer');
            container.innerHTML = '';
            addDirectionBlock('create', true); 

            openModal('trainModal');
        }

        async function openDetailModal(event) {
            const detailModal = document.getElementById('detailModal');
            const display = document.getElementById('detailDisplay');
            const editContainer = document.getElementById('detailEditFormContainer');
            const editForm = document.getElementById('detailEditForm');
            const eventProps = event.extendedProps;
            const eventId = event.id;

            // Сброс режима редактирования
            editContainer.classList.add('hidden');
            display.classList.remove('hidden');
            document.getElementById('toggleEditButton').textContent = 'Редактировать';
            document.getElementById('saveEditButton').classList.add('hidden');
            document.getElementById('deleteButton').classList.remove('hidden');
            
            document.getElementById('detailModalTitle').textContent = event.title;
            document.getElementById('detailEventId').value = eventId;
            document.getElementById('deleteButton').onclick = () => deleteEvent(eventId);

            // Рендеринг деталей для просмотра
            let detailsHtml = `
                <p><span class="font-semibold">Дата:</span> ${event.startStr.split('T')[0]}</p>
                <p><span class="font-semibold">Сервис:</span> ${eventProps.service}</p>
                <p><span class="font-semibold">Собственник:</span> ${eventProps.owner || 'Не указан'}</p>
                <p><span class="font-semibold">Перегруз:</span> ${eventProps.overload || 'Нет'}</p>
                <p><span class="font-semibold">Комментарий:</span> ${eventProps.comment || 'Нет'}</p>
            `;

            let stockDisplayHtml = '<h4 class="font-semibold mt-3">Привязанные стоки:</h4>';
            let totalTeuHtml = '';

            try {
                const directionalStocks = eventProps.stock ? JSON.parse(eventProps.stock) : [];

                if (Array.isArray(directionalStocks) && directionalStocks.length > 0) {
                    directionalStocks.forEach(item => {
                        const direction = item.direction || 'Неизвестное направление';
                        const stocks = item.stocks || [];
                        
                        stockDisplayHtml += `<div class="p-2 border rounded-lg bg-gray-50 mt-2">
                            <p class="font-medium text-indigo-700">${direction}:</p>
                            <div class="flex flex-wrap pt-1">
                                ${stocks.map(s => `<span class="stock-tag">${s}</span>`).join('') || '— Стоки не привязаны'}
                            </div>
                        </div>`;
                    });
                } else if (eventProps.stock) {
                    // Старый формат
                    stockDisplayHtml += `<p class="italic text-sm text-gray-500">Старый формат: ${eventProps.stock}</p>`;
                } else {
                    stockDisplayHtml += '<p>Стоки не привязаны.</p>';
                }

                if (eventProps.current_teu !== null && eventProps.current_teu !== undefined) {
                    totalTeuHtml = `<p class="teu-label text-xl mt-3">Итого TEU (Свободные контейнеры): ${eventProps.current_teu}</p>`;
                }


            } catch (e) {
                console.warn("Ошибка парсинга JSON stock_info, используя старый формат или сырую строку.", e);
                stockDisplayHtml += `<p class="italic text-sm text-gray-500">Сырые данные: ${eventProps.stock || 'Нет'}</p>`;
            }

            display.innerHTML = detailsHtml + stockDisplayHtml + totalTeuHtml;
            
            // Предзаполнение формы редактирования
            document.getElementById('editComment').value = eventProps.comment || '';
            
            // Очистка и предзаполнение блока стоков/направлений для редактирования
            const editContainerEl = document.getElementById('editDirectionStockContainer');
            editContainerEl.innerHTML = '';
            try {
                 const currentStocks = eventProps.stock ? JSON.parse(eventProps.stock) : [];
                 if (Array.isArray(currentStocks) && currentStocks.length > 0) {
                    currentStocks.forEach(data => addDirectionBlock('edit', false, data.direction, data.stocks));
                 } else {
                    // Инициализация пустым блоком для начала редактирования
                    addDirectionBlock('edit', true);
                 }
            } catch (e) {
                // Если парсинг не удался (старый формат), начинаем с пустого блока
                addDirectionBlock('edit', true);
            }

            openModal('detailModal');
        }

        // --- УПРАВЛЕНИЕ РЕЖИМОМ РЕДАКТИРОВАНИЯ ---

        function toggleEditMode() {
            const detailDisplay = document.getElementById('detailDisplay');
            const editContainer = document.getElementById('detailEditFormContainer');
            const toggleButton = document.getElementById('toggleEditButton');
            const saveButton = document.getElementById('saveEditButton');
            const deleteButton = document.getElementById('deleteButton');
            
            const isEditing = editContainer.classList.contains('hidden');

            if (isEditing) {
                // Включаем режим редактирования
                detailDisplay.classList.add('hidden');
                editContainer.classList.remove('hidden');
                toggleButton.textContent = 'Отменить';
                saveButton.classList.remove('hidden');
                deleteButton.classList.add('hidden');
            } else {
                // Выключаем режим редактирования
                detailDisplay.classList.remove('hidden');
                editContainer.classList.add('hidden');
                toggleButton.textContent = 'Редактировать';
                saveButton.classList.add('hidden');
                deleteButton.classList.remove('hidden');
            }
        }

        async function submitEditForm() {
            const eventId = document.getElementById('detailEventId').value;
            const editForm = document.getElementById('detailEditForm');

            // 1. Сбор и конвертация данных стоков/направлений в JSON
            const jsonString = collectDirectionStockData('edit');
            document.getElementById('editStockDataJson').value = jsonString;

            const formData = new FormData(editForm);
            
            // Удаляем ненужный event_id из Form, так как он в URL
            formData.delete('event_id');

            try {
                const response = await fetch(`/admin/api/schedule/${eventId}/update_details`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.status === 'ok') {
                    closeModal(null, 'detailModal');
                    window.calendarInstance.refetchEvents(); // Обновляем календарь
                } else {
                    alert('Ошибка при сохранении изменений: ' + (result.detail || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Update error:', error);
                alert('Ошибка сети при сохранении изменений.');
            }
        }

        // --- УПРАВЛЕНИЕ СТОКАМИ И НАПРАВЛЕНИЯМИ ---

        /**
         * Добавляет блок для выбора направления и стоков.
         * @param {string} mode - 'create' или 'edit'.
         * @param {boolean} forceAdd - Добавить, даже если контейнер не пуст.
         * @param {string} initialDirection - Начальное направление (для редактирования).
         * @param {Array<string>} initialStocks - Начальные стоки (для редактирования).
         */
        function addDirectionBlock(mode = 'create', forceAdd = false, initialDirection = '', initialStocks = []) {
            const containerId = mode === 'create' ? 'directionStockContainer' : 'editDirectionStockContainer';
            const container = document.getElementById(containerId);

            if (!forceAdd && container.children.length > 0 && mode === 'create') {
                // Если в режиме создания уже есть блок, не добавляем
                return;
            }
            
            const blockIndex = container.children.length;
            
            const block = document.createElement('div');
            block.className = 'direction-block relative';
            block.dataset.index = blockIndex;
            block.innerHTML = `
                <button type="button" onclick="removeDirectionBlock(this)" 
                        class="absolute top-2 right-2 text-red-500 hover:text-red-700 ${blockIndex === 0 && !initialDirection ? 'hidden' : ''}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                </button>
                
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700">Направление</label>
                    <select onchange="updateStockDropdown(this, '${mode}')" data-type="direction" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" required>
                        <option value="">-- Выберите направление --</option>
                        ${window.uniqueDirections.map(d => `<option value="${d}">${d}</option>`).join('')}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Привязанные стоки (можно выбрать несколько)</label>
                    <select multiple data-type="stocks" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border h-20">
                        <!-- Стоки будут загружены после выбора направления -->
                    </select>
                </div>
            `;
            container.appendChild(block);

            // Предзаполнение для режима редактирования
            if (initialDirection) {
                const directionSelect = block.querySelector('select[data-type="direction"]');
                directionSelect.value = initialDirection;
                updateStockDropdown(directionSelect, mode, initialStocks);
                block.querySelector('button').classList.remove('hidden');
            }
        }

        function removeDirectionBlock(button) {
            const block = button.closest('.direction-block');
            block.remove();
        }

        /**
         * Обновляет список стоков во втором select в зависимости от выбранного направления.
         * @param {HTMLSelectElement} directionSelect - Элемент select с направлением.
         * @param {string} mode - 'create' или 'edit'.
         * @param {Array<string>} initialStocks - Начальные стоки для предвыбора.
         */
        function updateStockDropdown(directionSelect, mode, initialStocks = []) {
            const block = directionSelect.closest('.direction-block');
            const stocksSelect = block.querySelector('select[data-type="stocks"]');
            const selectedDirection = directionSelect.value;
            
            stocksSelect.innerHTML = '';
            
            if (selectedDirection) {
                // Фильтруем стоки по выбранному направлению
                const filteredStocks = window.stocksList.filter(s => s.direction === selectedDirection);

                // Добавляем опции
                filteredStocks.forEach(stock => {
                    const option = document.createElement('option');
                    const isSelected = initialStocks.includes(stock.name);
                    
                    option.value = stock.name;
                    option.textContent = `${stock.name} (${stock.teu} TEU)`;
                    if (isSelected) {
                        option.selected = true;
                    }
                    stocksSelect.appendChild(option);
                });
            } else {
                stocksSelect.innerHTML = '<option value="">-- Сначала выберите направление --</option>';
            }
        }

        /**
         * Собирает данные из всех динамических блоков и конвертирует их в JSON строку.
         * @param {string} mode - 'create' или 'edit'.
         * @returns {string} JSON-строка.
         */
        function collectDirectionStockData(mode = 'create') {
            const containerId = mode === 'create' ? 'directionStockContainer' : 'editDirectionStockContainer';
            const container = document.getElementById(containerId);
            const data = [];

            Array.from(container.children).forEach(block => {
                const directionSelect = block.querySelector('select[data-type="direction"]');
                const stocksSelect = block.querySelector('select[data-type="stocks"]');
                
                const selectedStocks = Array.from(stocksSelect.selectedOptions).map(option => option.value);

                if (directionSelect.value) {
                    data.push({
                        direction: directionSelect.value,
                        stocks: selectedStocks
                    });
                }
            });

            // Возвращаем JSON-строку только если есть данные, иначе пустую строку
            return data.length > 0 ? JSON.stringify(data) : '';
        }
        
        // --- ОБЩАЯ ФУНКЦИЯ ОТПРАВКИ ---

        async function handleSubmit(form, calendar, mode) {
            // 1. Сбор и конвертация данных стоков/направлений в JSON
            const jsonString = collectDirectionStockData('create');
            document.getElementById('stockDataJson').value = jsonString;

            const formData = new FormData(form);
            const url = '/admin/api/schedule/create';

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'ok') {
                    closeModal();
                    calendar.refetchEvents(); // Обновляем календарь
                } else {
                    alert('Ошибка при создании поезда: ' + (result.detail || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Submit error:', error);
                alert('Ошибка сети при отправке данных.');
            }
        }
        
        async function deleteEvent(eventId) {
            if (!confirm('Вы уверены, что хотите удалить этот поезд?')) return;
            
            try {
                const response = await fetch(`/admin/api/schedule/${eventId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.status === 'ok') {
                    closeModal(null, 'detailModal');
                    window.calendarInstance.refetchEvents(); // Обновляем календарь
                } else {
                    alert('Ошибка при удалении поезда: ' + (result.detail || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Ошибка сети при удалении.');
            }
        }

        // --- ФУНКЦИЯ ЗАГРУЗКИ СТОКОВ ---

        async function fetchStocksList() {
            try {
                // Используем правильный путь с /admin
                const response = await fetch('/admin/api/schedule/stocks_list');
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error("Error fetching stocks list:", error);
                return [];
            }
        }

    </script>
</body>
</html>