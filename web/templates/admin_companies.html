{% extends "base.html" %}

{% block title %}Управление компаниями — Logistrail{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-10 pb-12 animate-fade-in">

    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h1 class="text-3xl font-bold text-mono-black tracking-tight">Компании и Доступ</h1>
            <p class="text-sm text-mono-gray mt-1">Управление клиентами и правами пользователей</p>
        </div>
        
        <form action="/admin/companies/sync" method="POST">
            <button type="submit" class="group flex items-center gap-2 text-xs font-bold text-mono-black border border-mono-border bg-white hover:bg-mono-bg px-4 py-2.5 rounded-xl transition shadow-sm">
                <div class="p-1 bg-mono-black text-white rounded-full group-hover:scale-110 transition">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </div>
                <span>Синхронизировать (Terminal → Archive)</span>
            </button>
        </form>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
        
        <!-- ФОРМА СОЗДАНИЯ КОМПАНИИ -->
        <div class="bg-white p-8 rounded-2xl shadow-card border border-transparent h-full flex flex-col">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-8 h-8 rounded-lg bg-mono-bg flex items-center justify-center text-mono-black">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                </div>
                <h2 class="text-lg font-bold text-mono-black">Новая Компания</h2>
            </div>
            
            <form action="/admin/companies/create" method="POST" class="space-y-5 flex-grow">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-mono-gray uppercase ml-1">Название</label>
                        <input type="text" name="name" required placeholder="ООО Вектор" 
                               class="w-full px-4 py-3 bg-mono-bg border-transparent rounded-xl text-mono-black placeholder-gray-400 focus:bg-white focus:ring-2 focus:ring-mono-black transition outline-none text-sm font-medium">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-mono-gray uppercase ml-1">ИНН</label>
                        <input type="text" name="inn" placeholder="1234567890" 
                               class="w-full px-4 py-3 bg-mono-bg border-transparent rounded-xl text-mono-black placeholder-gray-400 focus:bg-white focus:ring-2 focus:ring-mono-black transition outline-none text-sm font-medium">
                    </div>
                </div>
                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-mono-gray uppercase ml-1">Ключ импорта (Excel)</label>
                    <input type="text" name="import_key" required placeholder="VECTOR_LLC" 
                           class="w-full px-4 py-3 bg-mono-bg border-transparent rounded-xl text-mono-black placeholder-gray-400 focus:bg-white focus:ring-2 focus:ring-mono-black transition outline-none text-sm font-medium">
                    <p class="text-[10px] text-mono-gray ml-1 mt-1">Точное название клиента в столбце "Клиент" файла терминала.</p>
                </div>
                
                <div class="pt-4 mt-auto">
                    <button type="submit" class="w-full bg-mono-black text-white font-bold py-3 rounded-xl hover:opacity-90 transition shadow-lg active:scale-95 text-sm">
                        Создать компанию
                    </button>
                </div>
            </form>
        </div>

        <!-- ФОРМА СОЗДАНИЯ ПОЛЬЗОВАТЕЛЯ -->
        <div class="bg-white p-8 rounded-2xl shadow-card border border-transparent h-full flex flex-col">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-8 h-8 rounded-lg bg-mono-bg flex items-center justify-center text-mono-black">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                </div>
                <h2 class="text-lg font-bold text-mono-black">Новый Web-пользователь</h2>
            </div>
            
            <form action="/admin/users/create" method="POST" class="space-y-5 flex-grow">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-mono-gray uppercase ml-1">Имя</label>
                        <input type="text" name="name" required placeholder="Иван Петров" 
                               class="w-full px-4 py-3 bg-mono-bg border-transparent rounded-xl text-mono-black placeholder-gray-400 focus:bg-white focus:ring-2 focus:ring-mono-black transition outline-none text-sm font-medium">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-mono-gray uppercase ml-1">Компания</label>
                        <div class="relative">
                            <select name="company_id" class="w-full px-4 py-3 bg-mono-bg border-transparent rounded-xl text-mono-black focus:bg-white focus:ring-2 focus:ring-mono-black transition outline-none text-sm font-medium appearance-none cursor-pointer">
                                <option value="0">— Без компании —</option>
                                {% for comp in companies %}
                                <option value="{{ comp.id }}">{{ comp.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-mono-gray">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-mono-gray uppercase ml-1">Логин</label>
                        <input type="text" name="login" required placeholder="client_login" 
                               class="w-full px-4 py-3 bg-mono-bg border-transparent rounded-xl text-mono-black placeholder-gray-400 focus:bg-white focus:ring-2 focus:ring-mono-black transition outline-none text-sm font-medium">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-mono-gray uppercase ml-1">Пароль</label>
                        <input type="text" name="password" required placeholder="••••••" 
                               class="w-full px-4 py-3 bg-mono-bg border-transparent rounded-xl text-mono-black placeholder-gray-400 focus:bg-white focus:ring-2 focus:ring-mono-black transition outline-none text-sm font-medium">
                    </div>
                </div>
                
                <div class="pt-4 mt-auto">
                    <button type="submit" class="w-full bg-white border border-mono-black text-mono-black font-bold py-3 rounded-xl hover:bg-mono-black hover:text-white transition shadow-sm active:scale-95 text-sm">
                        Создать пользователя
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- СПИСОК КОМПАНИЙ -->
    <div class="bg-white rounded-2xl shadow-card border border-transparent overflow-hidden">
        <div class="px-8 py-6 bg-white border-b border-mono-border flex justify-between items-center">
            <h3 class="text-lg font-bold text-mono-black flex items-center gap-3">
                Активные компании
                <span class="bg-mono-bg text-mono-black px-2.5 py-0.5 rounded-md text-xs font-bold">{{ companies|length }}</span>
            </h3>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="bg-mono-bg text-mono-gray text-[11px] uppercase font-bold tracking-wider">
                    <tr>
                        <th class="px-8 py-4">Компания</th>
                        <th class="px-8 py-4">ИНН</th>
                        <th class="px-8 py-4">Ключ импорта</th>
                        <th class="px-8 py-4 text-center">Сотрудников</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-mono-border">
                    {% for company in companies %}
                    <tr class="hover:bg-mono-bg transition group">
                        <td class="px-8 py-5">
                            <div class="font-bold text-mono-black text-base">{{ company.name }}</div>
                            <div class="text-[10px] text-mono-gray font-mono mt-0.5">ID: #{{ company.id }}</div>
                        </td>
                        <td class="px-8 py-5 text-mono-black font-medium">{{ company.inn or '—' }}</td>
                        <td class="px-8 py-5">
                            {% if company.import_mapping_key %}
                                <span class="bg-white border border-mono-border text-mono-black px-2 py-1 rounded font-mono text-xs">{{ company.import_mapping_key }}</span>
                            {% else %}
                                <span class="text-gray-300 text-xs">—</span>
                            {% endif %}
                        </td>
                        <td class="px-8 py-5 text-center">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-mono-black text-white text-xs font-bold rounded-full">{{ company.users|length }}</span>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" class="px-8 py-10 text-center text-mono-gray">Список компаний пуст.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- СПИСОК ПОЛЬЗОВАТЕЛЕЙ -->
    <div class="bg-white rounded-2xl shadow-card border border-transparent overflow-hidden">
        <div class="px-8 py-6 bg-white border-b border-mono-border flex justify-between items-center">
            <h3 class="text-lg font-bold text-mono-black flex items-center gap-3">
                Пользователи и Права
                <span class="bg-mono-bg text-mono-black px-2.5 py-0.5 rounded-md text-xs font-bold">{{ users|length }}</span>
            </h3>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="bg-mono-bg text-mono-gray text-[11px] uppercase font-bold tracking-wider">
                    <tr>
                        <th class="px-6 py-4">Пользователь</th>
                        <th class="px-6 py-4">Компания</th>
                        <th class="px-6 py-4">Роль</th>
                        <th class="px-6 py-4 w-40">Смена пароля</th>
                        <th class="px-6 py-4 text-right">Действие</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-mono-border">
                    {% for user in users %}
                    <tr class="hover:bg-mono-bg transition group">
                        <form action="/admin/users/{{ user.id }}/update" method="POST">
                            
                            <td class="px-6 py-4 align-middle">
                                <div class="font-bold text-mono-black">
                                    {{ user.first_name }} {{ user.last_name or '' }}
                                </div>
                                <div class="text-xs text-mono-gray font-mono mt-0.5">
                                    {% if user.username %}
                                        @{{ user.username }}
                                        <span class="inline-block ml-1 px-1.5 rounded bg-mono-black text-white text-[9px]">TG</span>
                                    {% elif user.email_login %}
                                        {{ user.email_login }}
                                        <span class="inline-block ml-1 px-1.5 rounded bg-gray-200 text-gray-600 text-[9px]">WEB</span>
                                    {% else %}
                                        ID: {{ user.id }}
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 align-middle">
                                <select name="company_id" class="bg-white border-b border-mono-gray text-mono-black text-xs focus:border-mono-black focus:ring-0 block w-full py-1 pr-8 bg-transparent outline-none cursor-pointer hover:bg-mono-bg transition">
                                    <option value="0" {% if not user.company_id %}selected{% endif %}>— Нет —</option>
                                    {% for comp in companies %}
                                    <option value="{{ comp.id }}" {% if user.company_id == comp.id %}selected{% endif %}>
                                        {{ comp.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>

                            <td class="px-6 py-4 align-middle">
                                <select name="role" class="bg-white border-b border-mono-gray text-mono-black text-xs focus:border-mono-black focus:ring-0 block w-full py-1 pr-8 bg-transparent outline-none cursor-pointer hover:bg-mono-bg transition uppercase font-bold tracking-wide">
                                    <option value="viewer" {% if user.role == 'viewer' %}selected{% endif %}>Viewer</option>
                                    <option value="manager" {% if user.role == 'manager' %}selected{% endif %}>Manager</option>
                                    <option value="owner" {% if user.role == 'owner' %}selected{% endif %}>Owner</option>
                                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>ADMIN</option>
                                </select>
                            </td>

                            <!-- ПОЛЕ СМЕНЫ ПАРОЛЯ -->
                            <td class="px-6 py-4 align-middle">
                                <input type="text" name="new_password" placeholder="Новый пароль" 
                                       class="w-full bg-white border-b border-mono-gray text-mono-black text-xs py-1 px-2 outline-none focus:border-mono-black focus:bg-white transition placeholder-gray-300">
                            </td>

                            <td class="px-6 py-4 text-right align-middle">
                                <button type="submit" class="text-mono-black hover:bg-mono-black hover:text-white font-bold text-xs bg-white border border-mono-border px-4 py-2 rounded-lg transition shadow-sm">
                                    Сохранить
                                </button>
                            </td>
                        </form>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock %}