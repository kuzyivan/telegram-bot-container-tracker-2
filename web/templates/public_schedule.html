<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì—Ä–∞—Ñ–∏–∫ –ø–æ–µ–∑–¥–æ–≤ ({{ link_name }})</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* --- –°—Ç–∏–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è --- */
        .fc-event {
            background-color: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            /* border-left –∑–∞–¥–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤ JS */
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 4px !important;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        .fc-event:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .fc-daygrid-event { white-space: normal !important; align-items: flex-start; }
        .fc-event-main { width: 100%; padding: 0; }
        .fc-toolbar-title { font-size: 1.5rem !important; text-transform: capitalize; font-weight: 700; color: #1e293b; }
        .fc-button { background-color: white !important; color: #475569 !important; border: 1px solid #e2e8f0 !important; text-transform: capitalize; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .fc-button:hover { background-color: #f8fafc !important; }
        .fc-button-active { background-color: #eff6ff !important; color: #2563eb !important; border-color: #bfdbfe !important; }
        .fc-day-today { background-color: #f8fafc !important; }

        /* --- –ê–Ω–∏–º–∞—Ü–∏—è –ú–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ --- */
        #modalOverlay { transition: opacity 0.3s ease-out; }
        #modalPanel { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        .modal-closed {
            opacity: 0;
            pointer-events: none;
        }
        .modal-closed #modalPanel {
            transform: scale(0.95) translateY(10px);
            opacity: 0;
        }
        .modal-open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-open #modalPanel {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-6">
        <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-900">–ì—Ä–∞—Ñ–∏–∫ –ø–æ–µ–∑–¥–æ–≤</h1>
                    <p class="text-xs text-slate-500">–î–æ—Å—Ç—É–ø: {{ link_name }}</p>
                </div>
            </div>
            
            <div class="flex gap-4 text-sm text-slate-600 items-center">
                <div class="flex items-center gap-2">
                    <span class="w-2.5 h-2.5 rounded-full bg-blue-500"></span>
                    <span>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</span>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div id='calendar' class="min-h-[600px]"></div>
        </div>
    </div>

    <div id="modalOverlay" class="fixed inset-0 z-50 flex items-center justify-center px-4 modal-closed">
        
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal()"></div>

        <div id="modalPanel" class="bg-white rounded-2xl shadow-2xl w-full max-w-md relative z-10 overflow-hidden">
            
            <div id="modalHeader" class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 transition-colors duration-300">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-white/80 text-xs font-bold uppercase tracking-wider mb-1" id="modalDate">–î–ê–¢–ê</p>
                        <h2 class="text-white text-2xl font-bold leading-tight" id="modalDest">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</h2>
                    </div>
                    <button onclick="closeModal()" class="text-white/70 hover:text-white transition p-1 rounded-full hover:bg-white/20">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <div class="p-6 space-y-5">
                
                <div class="flex items-start gap-3">
                    <div class="bg-slate-100 p-2 rounded-lg text-slate-600 mt-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 font-medium">–°–µ—Ä–≤–∏—Å –ø–æ–µ–∑–¥–∞</p>
                        <p class="text-lg font-bold text-slate-800" id="modalService">Service Name</p>
                    </div>
                </div>

                <div class="flex items-start gap-3" id="blockStock">
                    <div class="bg-slate-100 p-2 rounded-lg text-slate-500 mt-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 font-medium">–î–æ—Å—Ç—É–ø–Ω—ã–π —Å—Ç–æ–∫</p>
                        <p class="text-base font-semibold text-slate-700" id="modalStock">Stock Info</p>
                    </div>
                </div>

                <div class="flex items-start gap-3" id="blockOwner">
                    <div class="bg-slate-100 p-2 rounded-lg text-slate-500 mt-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500 font-medium">–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫</p>
                        <p class="text-base font-semibold text-slate-700" id="modalOwner">Owner Name</p>
                    </div>
                </div>
                
                <div id="blockComment" class="hidden pt-4 border-t border-slate-100">
                    <p class="text-sm text-slate-400 italic" id="modalComment"></p>
                </div>

            </div>
            
            <div class="bg-slate-50 px-6 py-3 border-t border-slate-100 flex justify-center">
                <button onclick="closeModal()" class="w-full py-2.5 text-sm font-bold text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-xl transition">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var token = "{{ token }}";

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ru',
                firstDay: 1,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek'
                },
                editable: false,
                selectable: false,
                events: `/api/share/${token}/events`,

                // –ö–ª–∏–∫ –ø–æ —Å–æ–±—ã—Ç–∏—é -> –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
                eventClick: function(info) {
                    info.jsEvent.preventDefault(); 
                    openModal(info.event);
                },

                // –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –¶–í–ï–¢–ù–û–ô –ø–æ–ª–æ—Å–∫–æ–π
                eventContent: function(arg) {
                    let props = arg.event.extendedProps;
                    // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Å –±—ç–∫–µ–Ω–¥–∞
                    let bgColor = arg.event.backgroundColor || '#3b82f6';
                    
                    let html = `<div class="flex flex-col gap-0.5 leading-tight py-1 px-2" style="border-left: 3px solid ${bgColor}">`;
                    html += `<div class="text-xs font-extrabold text-slate-800 truncate" title="${props.dest}">üìç ${props.dest}</div>`;
                    html += `<div class="text-[10px] font-bold text-slate-700 truncate">üöÜ ${props.service}</div>`;
                    
                    if (props.stock) {
                        html += `<div class="text-[10px] text-slate-600 truncate border-t border-slate-100 mt-0.5 pt-0.5">üì¶ ${props.stock}</div>`;
                    }
                    if (props.owner) {
                        html += `<div class="text-[10px] text-slate-500 italic truncate">üë§ ${props.owner}</div>`;
                    }
                    html += `</div>`;
                    
                    return { html: html }
                }
            });
            calendar.render();
        });

        // --- –õ–æ–≥–∏–∫–∞ –ú–æ–¥–∞–ª—å–Ω–æ–≥–æ –û–∫–Ω–∞ ---

        function openModal(event) {
            const props = event.extendedProps;
            
            // 1. –î–∞—Ç–∞
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = event.start.toLocaleDateString('ru-RU', dateOptions);
            document.getElementById('modalDate').innerText = dateStr;
            
            // 2. –î–∞–Ω–Ω—ã–µ
            document.getElementById('modalDest').innerText = props.dest;
            document.getElementById('modalService').innerText = props.service;
            
            // 3. –ö—Ä–∞—Å–∏–º —à–∞–ø–∫—É –º–æ–¥–∞–ª–∫–∏ –≤ —Ü–≤–µ—Ç —Å–æ–±—ã—Ç–∏—è!
            const color = event.backgroundColor || '#3b82f6';
            const header = document.getElementById('modalHeader');
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª–∞—Å—Å—ã –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ Tailwind –∏ —Å—Ç–∞–≤–∏–º —Å–≤–æ–π —Ü–≤–µ—Ç
            header.className = 'px-6 py-4 transition-colors duration-300'; 
            header.style.backgroundColor = color; 
            
            // –°—Ç–æ–∫
            const elStock = document.getElementById('modalStock');
            const blockStock = document.getElementById('blockStock');
            if (props.stock) {
                elStock.innerText = props.stock;
                blockStock.classList.remove('hidden');
                blockStock.classList.add('flex');
            } else {
                blockStock.classList.add('hidden');
                blockStock.classList.remove('flex');
            }
            
            // –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫
            const elOwner = document.getElementById('modalOwner');
            const blockOwner = document.getElementById('blockOwner');
            if (props.owner) {
                elOwner.innerText = props.owner;
                blockOwner.classList.remove('hidden');
                blockOwner.classList.add('flex');
            } else {
                blockOwner.classList.add('hidden');
                blockOwner.classList.remove('flex');
            }

            // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            const elComment = document.getElementById('modalComment');
            const blockComment = document.getElementById('blockComment');
            if (props.comment) {
                elComment.innerText = props.comment;
                blockComment.classList.remove('hidden');
            } else {
                blockComment.classList.add('hidden');
            }

            // –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è
            const overlay = document.getElementById('modalOverlay');
            overlay.classList.remove('modal-closed');
            overlay.classList.add('modal-open');
        }

        function closeModal() {
            const overlay = document.getElementById('modalOverlay');
            overlay.classList.remove('modal-open');
            overlay.classList.add('modal-closed');
        }
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>