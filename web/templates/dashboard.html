{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî Logistrail{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8 animate-fade-in pb-12">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h1 class="text-3xl font-bold text-mono-black tracking-tight">–ë–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
            <p class="text-sm text-mono-gray mt-1">–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã</p>
        </div>
        
        <form action="/admin/dashboard" method="GET" class="flex items-center bg-white p-1 rounded-xl shadow-sm border border-mono-border">
            <input type="text" name="date_from" value="{{ current_date_from }}" class="datepicker w-32 px-3 py-2 text-sm bg-transparent outline-none text-center font-medium placeholder-mono-gray" placeholder="–ù–∞—á–∞–ª–æ">
            <div class="h-4 w-px bg-mono-border"></div>
            <input type="text" name="date_to" value="{{ current_date_to }}" class="datepicker w-32 px-3 py-2 text-sm bg-transparent outline-none text-center font-medium placeholder-mono-gray" placeholder="–ö–æ–Ω–µ—Ü">
            <button type="submit" class="ml-1 bg-mono-black text-white px-5 py-2 rounded-lg text-sm font-medium shadow-sm hover:bg-gray-800 transition">
                OK
            </button>
        </form>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        
        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</p>
            <div class="mt-2 flex items-baseline gap-2">
                <p class="text-3xl font-bold text-mono-black">{{ total_sent }}</p>
                <p class="text-sm text-mono-gray">–∫–æ–Ω—Ç.</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–°—Ä. —Å—Ä–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏</p>
            <div class="mt-2 flex items-baseline gap-2">
                <p class="text-3xl font-bold text-mono-black">{{ avg_delivery_days }}</p>
                <p class="text-sm text-mono-gray">–¥–Ω–µ–π</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–ü–æ–µ–∑–¥–æ–≤ –≤ –ø—É—Ç–∏</p>
            <p class="mt-2 text-3xl font-bold text-mono-black">{{ active_trains }}</p>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</p>
            <p class="mt-2 text-3xl font-bold text-mono-black">{{ new_users }}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <h3 class="text-base font-bold text-mono-black mb-6">–†–∏—Ç–º–∏—á–Ω–æ—Å—Ç—å –ø–æ–≥—Ä—É–∑–∫–∏</h3>
            <div class="relative h-72 w-full">
                <canvas id="rhythmChart"></canvas>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent flex flex-col">
            <h3 class="text-base font-bold text-mono-black mb-4">–¢–æ–ø –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
            <div class="relative h-64 w-full flex-grow flex items-center justify-center">
                <canvas id="clientsPieChart"></canvas>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <h3 class="text-base font-bold text-mono-black mb-6">–ù–∞–≥—Ä—É–∑–∫–∞ (–ó–∞–ø—Ä–æ—Å—ã)</h3>
            <div class="relative h-64 w-full">
                <canvas id="requestsChart"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-card border border-transparent flex flex-col overflow-hidden">
            <div class="p-6 border-b border-mono-border">
                <h3 class="text-base font-bold text-mono-black">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
            </div>
            <div class="flex-grow overflow-y-auto max-h-[250px]">
                <table class="w-full text-sm text-left">
                    <tbody class="divide-y divide-mono-border">
                        {% for item in feed_data %}
                        <tr class="hover:bg-mono-bg transition">
                            <td class="px-6 py-3.5">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="font-bold text-mono-black text-xs">{{ item.username }}</span>
                                    <span class="text-[10px] text-mono-gray font-mono">{{ item.time }}</span>
                                </div>
                                <div class="text-xs text-mono-gray bg-mono-bg rounded px-2 py-1 inline-block truncate max-w-full font-mono">
                                    {{ item.query }}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ —á–∞—Ä—Ç–æ–≤, —á—Ç–æ–±—ã —É–¥–∞–ª—è—Ç—å –∏—Ö –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
    window.dashboardCharts = window.dashboardCharts || {};

    function initDashboard() {
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Datepicker
        if (typeof flatpickr !== 'undefined') {
            flatpickr(".datepicker", {
                locale: "ru",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d.m.Y",
                allowInput: true,
                disableMobile: "true"
            });
        }

        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–∞–Ω–≤–∞—Å—ã (—á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö)
        if (!document.getElementById('rhythmChart')) return;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Chart.js
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#8E8E93';
        const gridColor = '#F5F5F7';

        // –§—É–Ω–∫—Ü–∏—è-—Ö–µ–ª–ø–µ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ä—Ç–∞ —Å –∞–≤—Ç–æ-—É–¥–∞–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ä–æ–≥–æ
        function createChart(id, config) {
            const ctx = document.getElementById(id);
            if (!ctx) return;

            // –ï—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - —É–Ω–∏—á—Ç–æ–∂–∞–µ–º –µ–≥–æ
            if (window.dashboardCharts[id]) {
                window.dashboardCharts[id].destroy();
            }

            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            window.dashboardCharts[id] = new Chart(ctx, config);
        }

        // --- 1. Line: Rhythm ---
        createChart('rhythmChart', {
            type: 'line',
            data: {
                labels: {{ rhythm_labels|safe }},
                datasets: [
                    {
                        label: '–¢—Ä–µ–Ω–¥',
                        data: {{ trend_values|safe }},
                        borderColor: '#CCCCCC',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        tension: 0.4,
                        order: 0
                    },
                    {
                        label: '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤',
                        data: {{ rhythm_values|safe }},
                        borderColor: '#111111',
                        backgroundColor: function(ctx) {
                            const canvas = ctx.chart.ctx;
                            if (!canvas) return '#111111';
                            const gradient = canvas.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(17, 17, 17, 0.1)');
                            gradient.addColorStop(1, 'rgba(17, 17, 17, 0)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        pointBackgroundColor: '#111111',
                        borderWidth: 2,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { beginAtZero: true, grid: { color: gridColor }, border: { display: false } }, 
                    x: { grid: { display: false }, border: { display: false } } 
                }
            }
        });

        // --- 2. Doughnut: Clients ---
        createChart('clientsPieChart', {
            type: 'doughnut',
            data: {
                labels: {{ clients_labels|safe }},
                datasets: [{
                    data: {{ clients_values|safe }},
                    backgroundColor: [
                        '#111111', '#333333', '#555555', '#777777',
                        '#999999', '#BBBBBB', '#DDDDDD', '#EEEEEE'
                    ],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: { 
                    legend: { position: 'right', labels: { boxWidth: 8, usePointStyle: true, pointStyle: 'circle', padding: 15, font: {size: 11} } } 
                },
                layout: { padding: 0 }
            }
        });

        // --- 3. Bar: Requests ---
        createChart('requestsChart', {
            type: 'bar',
            data: {
                labels: {{ req_labels|safe }},
                datasets: [{
                    label: '–ó–∞–ø—Ä–æ—Å—ã',
                    data: {{ req_values|safe }},
                    backgroundColor: '#2B2B2B',
                    hoverBackgroundColor: '#111111',
                    borderRadius: 4,
                    maxBarThickness: 30
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { beginAtZero: true, grid: { color: gridColor }, border: { display: false } }, 
                    x: { grid: { display: false }, border: { display: false } } 
                }
            }
        });
    }

    // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –õ–æ–≥–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞ –¥–ª—è HTMX –∏ –æ–±—ã—á–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
    // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω (–ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ –≤ HTMX), –∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É.
    // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (F5/cmd+r), –∂–¥–µ–º DOMContentLoaded.
    if (document.readyState !== 'loading') {
        initDashboard();
    } else {
        document.addEventListener('DOMContentLoaded', initDashboard);
    }
</script>
{% endblock %}