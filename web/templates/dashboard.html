{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî Logistrail{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8 animate-fade-in pb-12">
    
    <!-- –®–∞–ø–∫–∞ –∏ –§–∏–ª—å—Ç—Ä –¥–∞—Ç -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h1 class="text-3xl font-bold text-mono-black tracking-tight">–ë–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
            <p class="text-sm text-mono-gray mt-1">–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã</p>
        </div>
        
        <form action="/admin/dashboard" method="GET" class="flex items-center bg-white p-1 rounded-xl shadow-sm border border-mono-border">
            <input type="text" name="date_from" value="{{ current_date_from }}" class="datepicker w-32 px-3 py-2 text-sm bg-transparent outline-none text-center font-medium placeholder-mono-gray" placeholder="–ù–∞—á–∞–ª–æ">
            <div class="h-4 w-px bg-mono-border"></div>
            <input type="text" name="date_to" value="{{ current_date_to }}" class="datepicker w-32 px-3 py-2 text-sm bg-transparent outline-none text-center font-medium placeholder-mono-gray" placeholder="–ö–æ–Ω–µ—Ü">
            <button type="submit" class="ml-1 bg-mono-black text-white px-5 py-2 rounded-lg text-sm font-medium shadow-sm hover:bg-gray-800 transition">
                OK
            </button>
        </form>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ KPI -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</p>
            <div class="mt-2 flex items-baseline gap-2">
                <p class="text-3xl font-bold text-mono-black">{{ total_sent }}</p>
                <p class="text-sm text-mono-gray">–∫–æ–Ω—Ç.</p>
            </div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–°—Ä. —Å—Ä–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏</p>
            <div class="mt-2 flex items-baseline gap-2">
                <p class="text-3xl font-bold text-mono-black">{{ avg_delivery_days }}</p>
                <p class="text-sm text-mono-gray">–¥–Ω–µ–π</p>
            </div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–ü–æ–µ–∑–¥–æ–≤ –≤ –ø—É—Ç–∏</p>
            <p class="mt-2 text-3xl font-bold text-mono-black">{{ active_trains }}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</p> 
            <p class="mt-2 text-3xl font-bold text-mono-black">{{ new_users }}</p>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫: –î–∏–Ω–∞–º–∏–∫–∞ –≥—Ä—É–∑–æ–æ–±–æ—Ä–æ—Ç–∞ -->
    <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-base font-bold text-mono-black">–î–∏–Ω–∞–º–∏–∫–∞ –≥—Ä—É–∑–æ–æ–±–æ—Ä–æ—Ç–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</h3>
            <div class="flex items-center gap-4 text-xs font-medium">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full" style="background-color: #FF7300;"></span>
                    <span class="text-mono-gray">–ü—Ä–∏–Ω—è—Ç–æ</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-mono-black"></span>
                    <span class="text-mono-gray">–û—Ç–≥—Ä—É–∂–µ–Ω–æ</span>
                </div>
            </div>
        </div>
        <div class="relative h-80 w-full">
            <canvas id="turnoverChart"></canvas>
        </div>
    </div>

    <!-- üî• –ù–û–í–´–ô –ë–õ–û–ö: –°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–æ–∫–∏ (Masonry Layout) -->
    <div class="mb-8">
        <h3 class="text-xl font-bold text-mono-black mb-6 flex items-center gap-2">
            –¢–µ–∫—É—â–µ–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç–æ–∫–∞—Ö (TEU)
        </h3>

        {% if grouped_stocks %}
            <!-- Masonry Container: –ö–æ–ª–æ–Ω–∫–∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–ª–æ—Ç–Ω–æ -->
            <div class="columns-1 md:columns-2 xl:columns-3 gap-6 space-y-6">
                
                {% for direction, stocks in grouped_stocks.items() %}
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è: –Ω–µ —Ä–∞–∑—Ä—ã–≤–∞–µ—Ç—Å—è –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏ -->
                <div class="break-inside-avoid bg-white p-5 rounded-2xl shadow-card border border-transparent flex flex-col transition hover:shadow-lg">
                    
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                    <div class="flex items-center justify-between mb-4 border-b border-mono-border pb-3">
                        <h4 class="text-sm font-bold text-mono-black uppercase tracking-wide">
                            {{ direction }}
                        </h4>
                        <span class="text-[10px] text-mono-gray bg-mono-bg px-2 py-0.5 rounded font-mono">
                            {{ stocks|length }} —Å—Ç–æ–∫–æ–≤
                        </span>
                    </div>

                    <!-- –°–µ—Ç–∫–∞ —Å—Ç–æ–∫–æ–≤ –í–ù–£–¢–†–ò –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º grid-cols-2 –∏–ª–∏ 3 –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏ -->
                    <div class="grid grid-cols-2 gap-4">
                        {% for stock in stocks %}
                        <div class="flex flex-col items-center relative">
                            
                            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–∫–∞ -->
                            <div class="text-center mb-1 w-full">
                                <h3 class="font-bold text-mono-gray text-[10px] truncate uppercase tracking-wider" title="{{ stock.stock_name }}">
                                    {{ stock.stock_name }}
                                </h3>
                            </div>

                            <!-- –ì—Ä–∞—Ñ–∏–∫ (w-24 h-24 = 96px) -->
                            <div class="relative w-24 h-24">
                                <canvas id="stockChart_{{ stock.id_suffix }}"></canvas>
                                <!-- –¶–µ–Ω—Ç—Ä -->
                                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                    <span class="text-lg font-extrabold text-mono-black leading-none">
                                        {{ stock.teu }}
                                    </span>
                                    <span class="text-[8px] text-mono-gray font-bold">TEU</span>
                                </div>
                            </div>

                            <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
                            <div class="w-24 mt-1 flex justify-between px-1 text-[9px] text-mono-gray">
                                <div class="flex items-center gap-1">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#111111]"></span>
                                    <span class="font-bold text-mono-black">{{ stock.c20 }}</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#FF7300]"></span>
                                    <span class="font-bold text-mono-black">{{ stock.c40 }}</span>
                                </div>
                            </div>

                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}

            </div>
        {% else %}
        <div class="bg-white rounded-xl p-12 text-center border border-dashed border-mono-border">
            <p class="text-mono-gray">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ</p>
        </div>
        {% endif %}
    </div>

    <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- –¢–æ–ø –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent flex flex-col">
            <h3 class="text-base font-bold text-mono-black mb-4">–¢–æ–ø –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
            <div class="relative h-64 w-full flex-grow flex items-center justify-center">
                <canvas id="clientsPieChart"></canvas>
            </div>
        </div>

        <!-- –ù–∞–≥—Ä—É–∑–∫–∞ (–ó–∞–ø—Ä–æ—Å—ã) -->
        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <h3 class="text-base font-bold text-mono-black mb-6">–ù–∞–≥—Ä—É–∑–∫–∞ (–ó–∞–ø—Ä–æ—Å—ã)</h3>
            <div class="relative h-64 w-full">
                <canvas id="requestsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- –õ–µ–Ω—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="bg-white rounded-2xl shadow-card border border-transparent flex flex-col overflow-hidden">
        <div class="p-6 border-b border-mono-border">
            <h3 class="text-base font-bold text-mono-black">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        </div>
        <div class="flex-grow overflow-y-auto max-h-[250px]">
            <table class="w-full text-sm text-left">
                <tbody class="divide-y divide-mono-border">
                    {% for item in feed_data %}
                    <tr class="hover:bg-mono-bg transition">
                        <td class="px-6 py-3.5">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-bold text-mono-black text-xs">{{ item.username }}</span>
                                <span class="text-[10px] text-mono-gray font-mono">{{ item.time }}</span>
                            </div>
                            <div class="text-xs text-mono-gray bg-mono-bg rounded px-2 py-1 inline-block truncate max-w-full font-mono">
                                {{ item.query }}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    window.dashboardCharts = window.dashboardCharts || {};

    function initDashboard() {
        if (typeof flatpickr !== 'undefined') {
            flatpickr(".datepicker", { locale: "ru", dateFormat: "Y-m-d", altInput: true, altFormat: "d.m.Y", allowInput: true, disableMobile: "true" });
        }

        if (!document.getElementById('turnoverChart')) return;

        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#8E8E93';
        const gridColor = '#F5F5F7';

        function createChart(id, config) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            if (window.dashboardCharts[id]) window.dashboardCharts[id].destroy();
            window.dashboardCharts[id] = new Chart(ctx, config);
        }

        // === –ì–†–ê–§–ò–ö 1: –û–±–æ—Ä–æ—Ç ===
        createChart('turnoverChart', {
            type: 'line',
            data: {
                labels: {{ turnover_labels|safe }},
                datasets: [
                    { label: '–ü—Ä–∏–Ω—è—Ç–æ', data: {{ accepted_values|safe }}, borderColor: '#FF7300', backgroundColor: 'rgba(255, 115, 0, 0.1)', borderWidth: 2, tension: 0.3, fill: true, pointRadius: 2 },
                    { label: '–û—Ç–≥—Ä—É–∂–µ–Ω–æ', data: {{ dispatched_values|safe }}, borderColor: '#111111', backgroundColor: 'rgba(17, 17, 17, 0.05)', borderWidth: 2, tension: 0.3, fill: true, pointRadius: 2 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                plugins: { legend: { display: false }, tooltip: { backgroundColor: '#111111', padding: 10, cornerRadius: 8 } },
                scales: { y: { beginAtZero: true, grid: { color: gridColor }, border: { display: false } }, x: { grid: { display: false }, border: { display: false } } }
            }
        });

        // === –ì–†–ê–§–ò–ö 2: –ö–ª–∏–µ–Ω—Ç—ã ===
        createChart('clientsPieChart', {
            type: 'doughnut',
            data: {
                labels: {{ clients_labels|safe }},
                datasets: [{
                    data: {{ clients_values|safe }},
                    backgroundColor: ['#111111', '#333333', '#555555', '#777777', '#999999', '#BBBBBB', '#DDDDDD', '#EEEEEE'],
                    borderWidth: 0, hoverOffset: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'right', labels: { boxWidth: 8, usePointStyle: true, pointStyle: 'circle', font: {size: 11} } } }, layout: { padding: 0 } }
        });

        // === –ì–†–ê–§–ò–ö 3: –ó–∞–ø—Ä–æ—Å—ã ===
        createChart('requestsChart', {
            type: 'bar',
            data: {
                labels: {{ req_labels|safe }},
                datasets: [{ label: '–ó–∞–ø—Ä–æ—Å—ã', data: {{ req_values|safe }}, backgroundColor: '#2B2B2B', hoverBackgroundColor: '#111111', borderRadius: 4, maxBarThickness: 30 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: gridColor }, border: { display: false } }, x: { grid: { display: false }, border: { display: false } } } }
        });

        // === –ì–†–ê–§–ò–ö–ò –°–¢–û–ö–û–í (–°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ) ===
        {% for direction, stocks in grouped_stocks.items() %}
            {% for stock in stocks %}
            (function() {
                const ctxId = 'stockChart_{{ stock.id_suffix }}';
                const ctx = document.getElementById(ctxId);
                if (ctx) {
                    if (window.dashboardCharts[ctxId]) window.dashboardCharts[ctxId].destroy();
                    
                    window.dashboardCharts[ctxId] = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ["20'", "40'"],
                            datasets: [{
                                data: [{{ stock.c20 }}, {{ stock.c40 }}],
                                // –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–µ —Ü–≤–µ—Ç–∞ (#111111 –∏ #FF7300 —Å opacity)
                                backgroundColor: [
                                    'rgba(17, 17, 17, 0.75)', 
                                    'rgba(255, 115, 0, 0.75)'
                                ],
                                hoverBackgroundColor: ['#111111', '#FF7300'],
                                borderWidth: 0,
                                hoverOffset: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '70%',
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: { label: function(context) { return ' ' + context.label + ': ' + context.raw + ' —à—Ç'; } },
                                    backgroundColor: '#111111',
                                    padding: 8,
                                    cornerRadius: 6,
                                    bodyFont: { size: 10 }
                                }
                            }
                        }
                    });
                }
            })();
            {% endfor %}
        {% endfor %}
    }

    if (document.readyState !== 'loading') {
        initDashboard();
    } else {
        document.addEventListener('DOMContentLoaded', initDashboard);
    }
</script>
{% endblock %}