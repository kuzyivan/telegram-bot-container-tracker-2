{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî Logistrail{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8 animate-fade-in pb-12">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h1 class="text-3xl font-bold text-mono-black tracking-tight">–ë–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
            <p class="text-sm text-mono-gray mt-1">–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã</p>
        </div>
        
        <form action="/admin/dashboard" method="GET" class="flex items-center bg-white p-1 rounded-xl shadow-sm border border-mono-border">
            <input type="text" name="date_from" value="{{ current_date_from }}" class="datepicker w-32 px-3 py-2 text-sm bg-transparent outline-none text-center font-medium placeholder-mono-gray" placeholder="–ù–∞—á–∞–ª–æ">
            <div class="h-4 w-px bg-mono-border"></div>
            <input type="text" name="date_to" value="{{ current_date_to }}" class="datepicker w-32 px-3 py-2 text-sm bg-transparent outline-none text-center font-medium placeholder-mono-gray" placeholder="–ö–æ–Ω–µ—Ü">
            <button type="submit" class="ml-1 bg-mono-black text-white px-5 py-2 rounded-lg text-sm font-medium shadow-sm hover:bg-gray-800 transition">
                OK
            </button>
        </form>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ KPI -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        
        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</p>
            <div class="mt-2 flex items-baseline gap-2">
                <p class="text-3xl font-bold text-mono-black">{{ total_sent }}</p>
                <p class="text-sm text-mono-gray">–∫–æ–Ω—Ç.</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–°—Ä. —Å—Ä–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏</p>
            <div class="mt-2 flex items-baseline gap-2">
                <p class="text-3xl font-bold text-mono-black">{{ avg_delivery_days }}</p>
                <p class="text-sm text-mono-gray">–¥–Ω–µ–π</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–ü–æ–µ–∑–¥–æ–≤ –≤ –ø—É—Ç–∏</p>
            <p class="mt-2 text-3xl font-bold text-mono-black">{{ active_trains }}</p>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</p> <p class="mt-2 text-3xl font-bold text-mono-black">{{ new_users }}</p>
        </div>
    </div>

    <!-- üî• –ù–û–í–´–ô –ë–õ–û–ö: –î–∏–Ω–∞–º–∏–∫–∞ –≥—Ä—É–∑–æ–æ–±–æ—Ä–æ—Ç–∞ (–í—Ö–æ–¥/–í—ã—Ö–æ–¥) -->
    <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-base font-bold text-mono-black">–î–∏–Ω–∞–º–∏–∫–∞ –≥—Ä—É–∑–æ–æ–±–æ—Ä–æ—Ç–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</h3>
            <div class="flex items-center gap-4 text-xs font-medium">
                <div class="flex items-center gap-2">
                    <!-- –û–±–Ω–æ–≤–ª–µ–Ω —Ü–≤–µ—Ç –ª–µ–≥–µ–Ω–¥—ã –Ω–∞ FF7300 -->
                    <span class="w-3 h-3 rounded-full" style="background-color: #FF7300;"></span>
                    <span class="text-mono-gray">–ü—Ä–∏–Ω—è—Ç–æ</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-mono-black"></span>
                    <span class="text-mono-gray">–û—Ç–≥—Ä—É–∂–µ–Ω–æ</span>
                </div>
            </div>
        </div>
        <div class="relative h-80 w-full">
            <canvas id="turnoverChart"></canvas>
        </div>
    </div>

    <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- –¢–æ–ø –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent flex flex-col">
            <h3 class="text-base font-bold text-mono-black mb-4">–¢–æ–ø –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
            <div class="relative h-64 w-full flex-grow flex items-center justify-center">
                <canvas id="clientsPieChart"></canvas>
            </div>
        </div>

        <!-- –ù–∞–≥—Ä—É–∑–∫–∞ (–ó–∞–ø—Ä–æ—Å—ã) -->
        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <h3 class="text-base font-bold text-mono-black mb-6">–ù–∞–≥—Ä—É–∑–∫–∞ (–ó–∞–ø—Ä–æ—Å—ã)</h3>
            <div class="relative h-64 w-full">
                <canvas id="requestsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- –õ–µ–Ω—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="bg-white rounded-2xl shadow-card border border-transparent flex flex-col overflow-hidden">
        <div class="p-6 border-b border-mono-border">
            <h3 class="text-base font-bold text-mono-black">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        </div>
        <div class="flex-grow overflow-y-auto max-h-[250px]">
            <table class="w-full text-sm text-left">
                <tbody class="divide-y divide-mono-border">
                    {% for item in feed_data %}
                    <tr class="hover:bg-mono-bg transition">
                        <td class="px-6 py-3.5">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-bold text-mono-black text-xs">{{ item.username }}</span>
                                <span class="text-[10px] text-mono-gray font-mono">{{ item.time }}</span>
                            </div>
                            <div class="text-xs text-mono-gray bg-mono-bg rounded px-2 py-1 inline-block truncate max-w-full font-mono">
                                {{ item.query }}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ —á–∞—Ä—Ç–æ–≤, —á—Ç–æ–±—ã —É–¥–∞–ª—è—Ç—å –∏—Ö –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π
    window.dashboardCharts = window.dashboardCharts || {};

    function initDashboard() {
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Datepicker
        if (typeof flatpickr !== 'undefined') {
            flatpickr(".datepicker", {
                locale: "ru",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d.m.Y",
                allowInput: true,
                disableMobile: "true"
            });
        }

        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–∞–Ω–≤–∞—Å—ã
        if (!document.getElementById('turnoverChart')) return;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Chart.js
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#8E8E93';
        const gridColor = '#F5F5F7';

        // –§—É–Ω–∫—Ü–∏—è-—Ö–µ–ª–ø–µ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ä—Ç–∞ —Å –∞–≤—Ç–æ-—É–¥–∞–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ä–æ–≥–æ
        function createChart(id, config) {
            const ctx = document.getElementById(id);
            if (!ctx) return;

            if (window.dashboardCharts[id]) {
                window.dashboardCharts[id].destroy();
            }
            window.dashboardCharts[id] = new Chart(ctx, config);
        }

        // üî• 1. –ù–û–í–´–ô –ì–†–ê–§–ò–ö: –û–±–æ—Ä–æ—Ç (Line + Line/Bar)
        createChart('turnoverChart', {
            type: 'line',
            data: {
                labels: {{ turnover_labels|safe }},
                datasets: [
                    {
                        label: '–ü—Ä–∏–Ω—è—Ç–æ',
                        data: {{ accepted_values|safe }},
                        borderColor: '#FF7300', // –û—Ä–∞–Ω–∂–µ–≤—ã–π (–±—ã–ª–æ —Å–∏–Ω–∏–π)
                        backgroundColor: 'rgba(255, 115, 0, 0.1)', // –û—Ä–∞–Ω–∂–µ–≤–∞—è –∑–∞–ª–∏–≤–∫–∞
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    },
                    {
                        label: '–û—Ç–≥—Ä—É–∂–µ–Ω–æ',
                        data: {{ dispatched_values|safe }},
                        borderColor: '#111111', // –ß–µ—Ä–Ω—ã–π
                        backgroundColor: 'rgba(17, 17, 17, 0.05)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#111111',
                        titleColor: '#FFFFFF',
                        bodyColor: '#FFFFFF',
                        padding: 10,
                        cornerRadius: 8,
                        displayColors: true
                    }
                },
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        grid: { color: gridColor }, 
                        border: { display: false } 
                    }, 
                    x: { 
                        grid: { display: false }, 
                        border: { display: false } 
                    } 
                }
            }
        });

        // --- 2. Doughnut: Clients ---
        createChart('clientsPieChart', {
            type: 'doughnut',
            data: {
                labels: {{ clients_labels|safe }},
                datasets: [{
                    data: {{ clients_values|safe }},
                    backgroundColor: [
                        '#111111', '#333333', '#555555', '#777777',
                        '#999999', '#BBBBBB', '#DDDDDD', '#EEEEEE'
                    ],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: { 
                    legend: { position: 'right', labels: { boxWidth: 8, usePointStyle: true, pointStyle: 'circle', padding: 15, font: {size: 11} } } 
                },
                layout: { padding: 0 }
            }
        });

        // --- 3. Bar: Requests ---
        createChart('requestsChart', {
            type: 'bar',
            data: {
                labels: {{ req_labels|safe }},
                datasets: [{
                    label: '–ó–∞–ø—Ä–æ—Å—ã',
                    data: {{ req_values|safe }},
                    backgroundColor: '#2B2B2B',
                    hoverBackgroundColor: '#111111',
                    borderRadius: 4,
                    maxBarThickness: 30
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { beginAtZero: true, grid: { color: gridColor }, border: { display: false } }, 
                    x: { grid: { display: false }, border: { display: false } } 
                }
            }
        });
    }

    if (document.readyState !== 'loading') {
        initDashboard();
    } else {
        document.addEventListener('DOMContentLoaded', initDashboard);
    }
</script>
{% endblock %}