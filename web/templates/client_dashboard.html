{% extends "base.html" %}

{% block title %}–ú–æ–∏ –≥—Ä—É–∑—ã ‚Äî {{ company.name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8 animate-fade-in pb-12">

    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h1 class="text-3xl font-bold text-mono-black tracking-tight">–û–±–∑–æ—Ä –ø–µ—Ä–µ–≤–æ–∑–æ–∫</h1>
            <div class="flex items-center gap-2 mt-1 text-sm text-mono-gray">
                <span class="font-medium text-mono-black">{{ company.name }}</span>
                <span>‚Ä¢</span>
                <span>{{ user.first_name }}</span>
            </div>
        </div>
        
        <!-- üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω—ã hx-get, hx-target, hx-include -->
        <form id="filter-form" 
              hx-get="/client/containers/search" 
              hx-target="#containers-table-body" 
              hx-swap="innerHTML"
              hx-include="input[name='q'], input[name='train']"
              class="flex items-center bg-white p-1 rounded-xl shadow-sm border border-mono-border">
            
            <input type="text" name="date_from" class="datepicker w-32 px-3 py-2 text-sm bg-transparent outline-none text-center font-medium placeholder-mono-gray" placeholder="–ù–∞—á–∞–ª–æ">
            <div class="h-4 w-px bg-mono-border"></div>
            <input type="text" name="date_to" class="datepicker w-32 px-3 py-2 text-sm bg-transparent outline-none text-center font-medium placeholder-mono-gray" placeholder="–ö–æ–Ω–µ—Ü">
            
            <button type="submit" class="ml-1 bg-mono-black text-white px-5 py-2 rounded-lg text-sm font-medium shadow-sm hover:bg-gray-800 transition">
                OK
            </button>
        </form>
    </div>

    <!-- –ë–ª–æ–∫–∏ KPI (–§–∏–ª—å—Ç—Ä—ã) -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        
        <div onclick="applyFilter('all')" 
             class="bg-white p-6 rounded-2xl shadow-card border border-transparent hover:border-mono-border transition cursor-pointer group relative overflow-hidden">
            <div class="flex justify-between items-start mb-2">
                <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–í—Å–µ–≥–æ</p>
                <div class="text-mono-gray group-hover:text-mono-black transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-mono-black">{{ kpi.total }}</p>
            <div class="absolute bottom-0 left-0 w-full h-1 bg-mono-bg">
                <div class="h-full bg-mono-black w-full"></div>
            </div>
        </div>

        <div onclick="applyFilter('terminal')"
             class="bg-white p-6 rounded-2xl shadow-card border border-transparent hover:border-mono-border transition cursor-pointer group relative overflow-hidden">
            <div class="flex justify-between items-start mb-2">
                <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–¢–µ—Ä–º–∏–Ω–∞–ª</p>
                <div class="text-mono-gray group-hover:text-mono-black transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-mono-black">{{ kpi.terminal }}</p>
            <div class="absolute bottom-0 left-0 w-full h-1 bg-mono-bg">
                <div class="h-full bg-gray-400 w-1/3"></div>
            </div>
        </div>

        <div onclick="applyFilter('transit')"
             class="bg-white p-6 rounded-2xl shadow-card border border-transparent hover:border-mono-border transition cursor-pointer group relative overflow-hidden">
            <div class="flex justify-between items-start mb-2">
                <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–í –ø—É—Ç–∏</p>
                <div class="text-mono-gray group-hover:text-mono-black transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-mono-black">{{ kpi.in_transit }}</p>
            <div class="absolute bottom-0 left-0 w-full h-1 bg-mono-bg">
                <div class="h-full bg-gray-600 w-2/3"></div>
            </div>
        </div>

        <div onclick="applyFilter('arrived')"
             class="bg-white p-6 rounded-2xl shadow-card border border-transparent hover:border-mono-border transition cursor-pointer group relative overflow-hidden">
            <div class="flex justify-between items-start mb-2">
                <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–ü—Ä–∏–±—ã–ª–æ</p>
                <div class="text-mono-gray group-hover:text-mono-black transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-mono-black">{{ kpi.arrived }}</p>
            <div class="absolute bottom-0 left-0 w-full h-1 bg-mono-bg">
                <div class="h-full bg-black w-full"></div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <h3 class="text-base font-bold text-mono-black mb-6">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º</h3>
            <div class="relative h-64 w-full">
                {% include "partials/clients_chart.html" %}
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent flex flex-col justify-between">
            <div>
                <h3 class="text-base font-bold text-mono-black mb-4">–ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ</h3>
                <div class="space-y-4">
                    <input type="text" name="q" form="filter-form" placeholder="–ù–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..." 
                           class="w-full px-4 py-3 bg-mono-bg border-none rounded-xl text-mono-black focus:ring-2 focus:ring-black placeholder-gray-400 transition outline-none font-mono text-sm">
                    
                    <input type="text" name="train" form="filter-form" placeholder="–ù–æ–º–µ—Ä –ø–æ–µ–∑–¥–∞..." 
                           class="w-full px-4 py-3 bg-mono-bg border-none rounded-xl text-mono-black focus:ring-2 focus:ring-black placeholder-gray-400 transition outline-none font-mono text-sm">
                </div>
            </div>
            <button type="button" onclick="htmx.trigger('#filter-form', 'submit')" 
                    class="mt-6 w-full bg-mono-black text-white font-bold py-3 rounded-xl hover:opacity-90 transition shadow-lg text-sm">
                –ù–∞–π—Ç–∏
            </button>
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-card border border-transparent overflow-hidden">
        <div class="px-6 py-5 border-b border-mono-border flex justify-between items-center">
            <h3 class="text-base font-bold text-mono-black">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è</h3>
            <button onclick="downloadReport()" class="text-xs font-bold text-mono-gray hover:text-mono-black flex items-center gap-2 transition uppercase tracking-wider">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                –°–∫–∞—á–∞—Ç—å Excel
            </button>
        </div>
        
        <div class="overflow-x-auto w-full">
            <table class="w-full min-w-[1000px] text-left border-collapse">
                <thead class="bg-mono-bg text-mono-gray text-[11px] uppercase font-bold tracking-wider">
                    <tr>
                        <th class="px-6 py-4">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä</th>
                        <th class="px-6 py-4">–ü–æ–µ–∑–¥</th>
                        <th class="px-6 py-4">–ú–∞—Ä—à—Ä—É—Ç</th>
                        <th class="px-6 py-4">–û–ø–µ—Ä–∞—Ü–∏—è</th>
                        <th class="px-6 py-4">–î–∞—Ç–∞ (UTC)</th>
                        <th class="px-6 py-4 text-right">–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody id="containers-table-body" class="divide-y divide-mono-border">
                    {% include "partials/client_table.html" %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- üî• –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –ú–û–î–ê–õ–ö–ò –ò–°–¢–û–†–ò–ò -->
<div id="history-modal-container"></div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        if (typeof flatpickr !== "undefined") {
            flatpickr(".datepicker", {
                locale: "ru",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d.m.Y",
                disableMobile: "true"
            });
        }
    });

    function applyFilter(status) {
        let input = document.getElementById('status-input');
        if(!input) {
            input = document.createElement('input');
            input.type = 'hidden';
            input.id = 'status-input';
            input.name = 'status';
            document.getElementById('filter-form').appendChild(input);
        }
        input.value = status;
        htmx.trigger('#filter-form', 'submit');
    }

    function downloadReport() {
        const form = document.getElementById('filter-form');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        window.open(`/client/export?${params.toString()}`, '_blank');
    }
</script>
{% endblock %}