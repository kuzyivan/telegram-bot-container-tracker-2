{% extends "base.html" %}

{% block title %}–ú–æ–∏ –≥—Ä—É–∑—ã ‚Äî {{ company.name }}{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 space-y-8 animate-fade-in pb-12">

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ò–Ω—Ñ–æ -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h1 class="text-3xl font-bold text-mono-black tracking-tight">–û–±–∑–æ—Ä –ø–µ—Ä–µ–≤–æ–∑–æ–∫</h1>
            <div class="flex items-center gap-2 mt-1 text-sm text-mono-gray">
                <span class="font-medium text-mono-black">{{ company.name }}</span>
                <span>‚Ä¢</span>
                <span>{{ user.first_name }}</span>
            </div>
        </div>
    </div>

    <!-- –ë–ª–æ–∫–∏ KPI (–í–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏) -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
        
        <div onclick="setQuickFilter('all')" 
             class="bg-white p-6 rounded-2xl shadow-card border border-transparent hover:border-mono-border transition cursor-pointer group relative overflow-hidden">
            <div class="flex justify-between items-start mb-2">
                <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–í—Å–µ–≥–æ</p>
                <div class="text-mono-gray group-hover:text-mono-black transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-mono-black">{{ kpi.total }}</p>
            <div class="absolute bottom-0 left-0 w-full h-1 bg-mono-bg"><div class="h-full bg-mono-black w-full"></div></div>
        </div>

        <div onclick="setQuickFilter('terminal')"
             class="bg-white p-6 rounded-2xl shadow-card border border-transparent hover:border-mono-border transition cursor-pointer group relative overflow-hidden">
            <div class="flex justify-between items-start mb-2">
                <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–¢–µ—Ä–º–∏–Ω–∞–ª</p>
                <div class="text-mono-gray group-hover:text-mono-black transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-mono-black">{{ kpi.terminal }}</p>
            <div class="absolute bottom-0 left-0 w-full h-1 bg-mono-bg"><div class="h-full bg-gray-400 w-1/3"></div></div>
        </div>

        <div onclick="setQuickFilter('transit')"
             class="bg-white p-6 rounded-2xl shadow-card border border-transparent hover:border-mono-border transition cursor-pointer group relative overflow-hidden">
            <div class="flex justify-between items-start mb-2">
                <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–í –ø—É—Ç–∏</p>
                <div class="text-mono-gray group-hover:text-mono-black transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-mono-black">{{ kpi.in_transit }}</p>
            <div class="absolute bottom-0 left-0 w-full h-1 bg-mono-bg"><div class="h-full bg-gray-600 w-2/3"></div></div>
        </div>

        <div onclick="setQuickFilter('arrived')"
             class="bg-white p-6 rounded-2xl shadow-card border border-transparent hover:border-mono-border transition cursor-pointer group relative overflow-hidden">
            <div class="flex justify-between items-start mb-2">
                <p class="text-xs font-bold text-mono-gray uppercase tracking-wider">–ü—Ä–∏–±—ã–ª–æ</p>
                <div class="text-mono-gray group-hover:text-mono-black transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-mono-black">{{ kpi.arrived }}</p>
            <div class="absolute bottom-0 left-0 w-full h-1 bg-mono-bg"><div class="h-full bg-black w-full"></div></div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ -->
    <div class="bg-white rounded-2xl shadow-card border border-transparent overflow-hidden flex flex-col">
        
        <div class="px-6 py-5 border-b border-mono-border flex justify-between items-center bg-white sticky left-0">
            <h3 class="text-base font-bold text-mono-black">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è</h3>
            <button onclick="downloadReport()" class="group flex items-center gap-2 text-xs font-bold text-mono-gray hover:text-mono-black transition uppercase tracking-wider">
                <div class="p-1.5 rounded-lg bg-mono-bg group-hover:bg-mono-black group-hover:text-white transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                </div>
                <span>Excel</span>
            </button>
        </div>
        
        <!-- –§–æ—Ä–º–∞ —Å–ª—É–∂–∏—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –¥–∞–Ω–Ω—ã—Ö –¥–ª—è hx-include, –Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–∞–º–∞ -->
        <form id="table-filters" class="contents" onsubmit="return false;">
            
            <div class="overflow-x-auto w-full custom-scrollbar">
                <table class="w-full min-w-[1000px] text-left border-collapse">
                    <thead class="bg-mono-bg text-mono-gray text-[11px] uppercase font-bold tracking-wider">
                        <!-- –ù–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ -->
                        <tr>
                            <th class="px-6 pt-4 pb-2 w-[20%]">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä</th>
                            <th class="px-6 pt-4 pb-2 w-[15%]">–ü–æ–µ–∑–¥</th>
                            <th class="px-6 pt-4 pb-2 w-[25%]">–ú–∞—Ä—à—Ä—É—Ç</th>
                            <th class="px-6 pt-4 pb-2 w-[20%]">–û–ø–µ—Ä–∞—Ü–∏—è</th>
                            <th class="px-6 pt-4 pb-2 w-[10%]">–î–∞—Ç–∞</th>
                            <th class="px-6 pt-4 pb-2 w-[10%] text-right">–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                        
                        <!-- üî• –°–¢–†–û–ö–ê –§–ò–õ–¨–¢–†–û–í (Inputs) -->
                        <tr class="bg-mono-bg border-b border-mono-border">
                            <!-- –§–∏–ª—å—Ç—Ä –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä (Live Search) -->
                            <th class="px-6 pb-4 pt-1">
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-4 w-4 text-gray-400 group-focus-within:text-mono-black transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                    </div>
                                    <input type="text" name="q" placeholder="–ü–æ–∏—Å–∫ –Ω–æ–º–µ—Ä–∞..." 
                                           class="block w-full pl-9 pr-3 py-2 border-none rounded-xl text-sm bg-white text-mono-black placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-mono-black/10 transition shadow-sm"
                                           hx-get="/client/containers/search" 
                                           hx-target="#containers-table-body" 
                                           hx-swap="innerHTML"
                                           hx-trigger="keyup changed delay:500ms, search"
                                           hx-include="#table-filters">
                                </div>
                            </th>

                            <!-- –§–∏–ª—å—Ç—Ä –ü–æ–µ–∑–¥ -->
                            <th class="px-6 pb-4 pt-1">
                                <div class="relative group">
                                    <input type="text" name="train" placeholder="‚Ññ –ø–æ–µ–∑–¥–∞" 
                                           class="block w-full px-3 py-2 border-none rounded-xl text-sm bg-white text-mono-black placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-mono-black/10 transition shadow-sm"
                                           hx-get="/client/containers/search" 
                                           hx-target="#containers-table-body" 
                                           hx-swap="innerHTML"
                                           hx-trigger="keyup changed delay:500ms, search"
                                           hx-include="#table-filters">
                                </div>
                            </th>

                            <!-- –ü—É—Å—Ç–æ–π (–ú–∞—Ä—à—Ä—É—Ç —Å–ª–æ–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ–ª–µ–º) -->
                            <th class="px-6 pb-4 pt-1"></th>

                            <!-- –ü—É—Å—Ç–æ–π (–û–ø–µ—Ä–∞—Ü–∏—è) -->
                            <th class="px-6 pb-4 pt-1"></th>

                            <!-- –§–∏–ª—å—Ç—Ä –î–∞—Ç–∞ (Flatpickr) -->
                            <th class="px-6 pb-4 pt-1">
                                <input type="text" name="date_from" class="datepicker block w-full px-2 py-2 border-none rounded-xl text-sm bg-white text-center text-mono-black placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-mono-black/10 transition shadow-sm cursor-pointer" 
                                       placeholder="–î–∞—Ç–∞"
                                       hx-get="/client/containers/search" 
                                       hx-target="#containers-table-body" 
                                       hx-swap="innerHTML"
                                       hx-trigger="change"
                                       hx-include="#table-filters">
                            </th>

                            <!-- –§–∏–ª—å—Ç—Ä –°—Ç–∞—Ç—É—Å (Combobox-like Select) -->
                            <th class="px-6 pb-4 pt-1">
                                <div class="relative">
                                    <select name="status" id="status-select"
                                            class="block w-full pl-3 pr-8 py-2 border-none rounded-xl text-sm bg-white text-mono-black focus:outline-none focus:ring-2 focus:ring-mono-black/10 transition shadow-sm appearance-none cursor-pointer"
                                            hx-get="/client/containers/search" 
                                            hx-target="#containers-table-body" 
                                            hx-swap="innerHTML"
                                            hx-trigger="change"
                                            hx-include="#table-filters">
                                        <option value="all">–í—Å–µ</option>
                                        <option value="terminal">–¢–µ—Ä–º–∏–Ω–∞–ª</option>
                                        <option value="transit">–í –ø—É—Ç–∏</option>
                                        <option value="arrived">–ü—Ä–∏–±—ã–ª</option>
                                    </select>
                                    <!-- –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ -->
                                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </div>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    
                    <tbody id="containers-table-body" class="divide-y divide-mono-border">
                        {% include "partials/client_table.html" %}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
</div>

<!-- üî• –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –ú–û–î–ê–õ–ö–ò –ò–°–¢–û–†–ò–ò -->
<div id="history-modal-container"></div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        if (typeof flatpickr !== "undefined") {
            flatpickr(".datepicker", {
                locale: "ru",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d.m.Y",
                disableMobile: "true",
                onChange: function(selectedDates, dateStr, instance) {
                    // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–∞—Ç—ã –≤—Ä—É—á–Ω—É—é –≤—ã–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ change –¥–ª—è HTMX
                    instance.element.dispatchEvent(new Event('change'));
                }
            });
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è KPI-–∫–∞—Ä—Ç–æ—á–µ–∫: –º–µ–Ω—è–µ—Ç —Å–µ–ª–µ–∫—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É
    function setQuickFilter(statusValue) {
        const select = document.getElementById('status-select');
        if (select) {
            select.value = statusValue;
            // –°–æ–∑–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–µ change, —á—Ç–æ–±—ã HTMX –ø–æ–¥—Ö–≤–∞—Ç–∏–ª –µ–≥–æ
            const event = new Event('change', { bubbles: true });
            select.dispatchEvent(event);
        }
    }

    function downloadReport() {
        const form = document.getElementById('table-filters');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        window.open(`/client/export?${params.toString()}`, '_blank');
    }
</script>
{% endblock %}