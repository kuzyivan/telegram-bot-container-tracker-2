{% extends "base.html" %}

{% block title %}Мои грузы — {{ company.name }}{% endblock %}

{% block content %}
<div class="w-full space-y-6 animate-fade-in pb-10">

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold text-mono-black tracking-tight">Обзор перевозок</h1>
            <p class="text-mono-gray text-sm mt-1">Компания: {{ company.name }}</p>
        </div>
        
        <form id="filter-form" class="flex gap-2 bg-white p-1 rounded-xl shadow-sm border border-mono-border">
            <input type="text" name="date_from" class="datepicker w-28 px-3 py-1.5 text-sm bg-transparent outline-none text-center font-medium" placeholder="С даты">
            <span class="text-mono-border self-center">|</span>
            <input type="text" name="date_to" class="datepicker w-28 px-3 py-1.5 text-sm bg-transparent outline-none text-center font-medium" placeholder="По дату">
            <button type="submit" class="bg-mono-black text-white px-4 py-1.5 rounded-lg text-sm font-medium shadow-sm hover:opacity-90 transition">
                Обновить
            </button>
        </form>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        
        <div onclick="applyFilter('all')" 
             class="bg-white p-6 rounded-2xl shadow-card border border-transparent hover:border-mono-border transition cursor-pointer group">
            <div class="flex justify-between items-start mb-4">
                <p class="text-sm font-medium text-mono-gray">Всего грузов</p>
                <div class="p-2 bg-mono-bg rounded-full text-mono-black group-hover:bg-black group-hover:text-white transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-mono-black">{{ kpi.total }}</p>
            <div class="mt-4 h-1 w-full bg-mono-bg rounded-full overflow-hidden">
                <div class="h-full bg-mono-black w-full"></div>
            </div>
        </div>

        <div onclick="applyFilter('terminal')"
             class="bg-white p-6 rounded-2xl shadow-card border border-transparent hover:border-mono-border transition cursor-pointer group">
            <div class="flex justify-between items-start mb-4">
                <p class="text-sm font-medium text-mono-gray">На терминале</p>
                <div class="p-2 bg-mono-bg rounded-full text-mono-black group-hover:bg-black group-hover:text-white transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-mono-black">{{ kpi.terminal }}</p>
            <div class="mt-4 h-1 w-full bg-mono-bg rounded-full overflow-hidden">
                <div class="h-full bg-gray-400 w-1/3"></div>
            </div>
        </div>

        <div onclick="applyFilter('transit')"
             class="bg-white p-6 rounded-2xl shadow-card border border-transparent hover:border-mono-border transition cursor-pointer group">
            <div class="flex justify-between items-start mb-4">
                <p class="text-sm font-medium text-mono-gray">В пути</p>
                <div class="p-2 bg-mono-bg rounded-full text-mono-black group-hover:bg-black group-hover:text-white transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-mono-black">{{ kpi.in_transit }}</p>
            <div class="mt-4 h-1 w-full bg-mono-bg rounded-full overflow-hidden">
                <div class="h-full bg-gray-600 w-2/3"></div>
            </div>
        </div>

        <div onclick="applyFilter('arrived')"
             class="bg-white p-6 rounded-2xl shadow-card border border-transparent hover:border-mono-border transition cursor-pointer group">
            <div class="flex justify-between items-start mb-4">
                <p class="text-sm font-medium text-mono-gray">Прибыло</p>
                <div class="p-2 bg-mono-bg rounded-full text-mono-black group-hover:bg-black group-hover:text-white transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
            </div>
            <p class="text-3xl font-bold text-mono-black">{{ kpi.arrived }}</p>
            <div class="mt-4 h-1 w-full bg-mono-bg rounded-full overflow-hidden">
                <div class="h-full bg-black w-full"></div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-card border border-transparent">
            <h3 class="text-lg font-bold text-mono-black mb-6">Динамика отправлений</h3>
            <div class="relative h-64 w-full">
                {% include "partials/clients_chart.html" %}
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-card border border-transparent flex flex-col">
            <h3 class="text-lg font-bold text-mono-black mb-4">Быстрый поиск</h3>
            <div class="flex-grow flex flex-col gap-4">
                <input type="text" name="q" form="filter-form" placeholder="Номер контейнера..." 
                       class="w-full px-4 py-3 bg-mono-bg border-none rounded-xl text-mono-black focus:ring-2 focus:ring-black placeholder-gray-400 transition outline-none font-mono">
                
                <input type="text" name="train" form="filter-form" placeholder="Номер поезда..." 
                       class="w-full px-4 py-3 bg-mono-bg border-none rounded-xl text-mono-black focus:ring-2 focus:ring-black placeholder-gray-400 transition outline-none font-mono">
                
                <button type="button" onclick="htmx.trigger('#filter-form', 'submit')" 
                        class="mt-auto w-full bg-mono-black text-white font-bold py-3 rounded-xl hover:opacity-90 transition shadow-lg">
                    Найти
                </button>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-card border border-transparent overflow-hidden">
        <div class="px-6 py-5 border-b border-mono-border flex justify-between items-center bg-white">
            <h3 class="text-lg font-bold text-mono-black">Список контейнеров</h3>
            
            <button onclick="downloadReport()" class="text-sm font-medium text-mono-gray hover:text-mono-black flex items-center gap-2 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Экспорт .xlsx
            </button>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full min-w-[1000px] text-left border-collapse">
                <thead class="bg-mono-bg text-mono-gray text-xs uppercase font-semibold tracking-wider">
                    <tr>
                        <th class="px-6 py-4">Контейнер</th>
                        <th class="px-6 py-4">Поезд</th>
                        <th class="px-6 py-4">Маршрут</th>
                        <th class="px-6 py-4">Операция</th>
                        <th class="px-6 py-4">Дата (UTC)</th>
                        <th class="px-6 py-4 text-right">Статус</th>
                    </tr>
                </thead>
                <tbody id="containers-table-body" class="divide-y divide-mono-border bg-white">
                    {% include "partials/client_table.html" %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    flatpickr(".datepicker", {
        locale: "ru",
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d.m.Y",
        disableMobile: "true"
    });

    function applyFilter(status) {
        // Логика фильтрации (добавить hidden input в форму)
        let input = document.getElementById('status-input');
        if(!input) {
            input = document.createElement('input');
            input.type = 'hidden';
            input.id = 'status-input';
            input.name = 'status';
            document.getElementById('filter-form').appendChild(input);
        }
        input.value = status;
        htmx.trigger('#filter-form', 'submit');
    }

    function downloadReport() {
        const form = document.getElementById('filter-form');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        window.open(`/client/export?${params.toString()}`, '_blank');
    }
</script>
{% endblock %}
