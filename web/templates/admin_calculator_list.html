{% extends "base.html" %}

{% block title %}–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ö–ü ‚Äî Logistrail{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-fade-in">
    
    <!-- –®–∞–ø–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 mb-6">
        <div>
            <h1 class="text-3xl font-bold text-mono-black tracking-tight">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ö–ü</h1>
            <p class="text-sm text-mono-gray mt-1">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏</p>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤ -->
        <button onclick="openModal()" class="flex items-center gap-2 bg-white text-mono-black border border-mono-border px-4 py-2.5 rounded-xl font-bold text-sm shadow-sm hover:bg-gray-50 transition active:scale-95">
            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
            –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞—Ä–∏—Ñ—ã –ñ–î
        </button>
    </div>

    <!-- –¢–ê–ë–´ –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø (TABS) -->
    <div class="bg-mono-bg p-1.5 rounded-2xl flex relative mb-8 shadow-inner">
        <!-- –¢–∞–± 1: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã–µ –ø–æ–µ–∑–¥–∞ -->
        <a href="/admin/calculator?type=TRAIN" 
           class="flex-1 flex flex-col justify-center items-center py-4 rounded-xl transition-all duration-300 group {{ 'bg-white shadow-md ring-1 ring-black/5' if current_type == 'TRAIN' else 'hover:bg-white/50' }}">
            <div class="flex items-center gap-2 mb-1">
                <svg class="w-5 h-5 {{ 'text-mono-black' if current_type == 'TRAIN' else 'text-mono-gray group-hover:text-mono-black' }} transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                <span class="text-base font-extrabold tracking-tight {{ 'text-mono-black' if current_type == 'TRAIN' else 'text-mono-gray group-hover:text-mono-black' }} transition-colors">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞</span>
            </div>
            <span class="text-[10px] uppercase tracking-widest font-bold {{ 'text-mono-gray' if current_type == 'TRAIN' else 'text-gray-400' }}">–í —Å–æ—Å—Ç–∞–≤–µ –ø–æ–µ–∑–¥–∞ (–ö–ü)</span>
        </a>
        
        <!-- –¢–∞–± 2: –í–∞–≥–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ -->
        <a href="/admin/calculator?type=SINGLE" 
           class="flex-1 flex flex-col justify-center items-center py-4 rounded-xl transition-all duration-300 group {{ 'bg-white shadow-md ring-1 ring-black/5' if current_type == 'SINGLE' else 'hover:bg-white/50' }}">
            <div class="flex items-center gap-2 mb-1">
                <svg class="w-5 h-5 {{ 'text-mono-black' if current_type == 'SINGLE' else 'text-mono-gray group-hover:text-mono-black' }} transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                <span class="text-base font-extrabold tracking-tight {{ 'text-mono-black' if current_type == 'SINGLE' else 'text-mono-gray group-hover:text-mono-black' }} transition-colors">–í–∞–≥–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞</span>
            </div>
            <span class="text-[10px] uppercase tracking-widest font-bold {{ 'text-mono-gray' if current_type == 'SINGLE' else 'text-gray-400' }}">–û–¥–∏–Ω–æ—á–Ω–∞—è / –ü–æ–≤–∞–≥–æ–Ω–Ω–∞—è</span>
        </a>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
    <div class="flex justify-end mb-6 animate-fade-in">
        <a href="/admin/calculator/new?type={{ current_type }}" 
           class="group flex items-center gap-2 bg-mono-black text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-gray-800 transition active:scale-95">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—á–µ—Ç ({{ '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã–π' if current_type == 'TRAIN' else '–í–∞–≥–æ–Ω–Ω—ã–π' }})
        </a>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    {% if request.query_params.get('success_msg') %}
    <div class="mb-6 p-4 bg-green-50 text-green-700 border border-green-200 rounded-xl text-sm font-medium animate-fade-in flex items-center gap-2">
        <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        {{ request.query_params.get('success_msg') }}
    </div>
    {% endif %}
    {% if request.query_params.get('error_msg') %}
    <div class="mb-6 p-4 bg-red-50 text-red-600 border border-red-200 rounded-xl text-sm font-medium animate-fade-in flex items-center gap-2">
        <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        {{ request.query_params.get('error_msg') }}
    </div>
    {% endif %}

    <!-- –ú–ê–ö–†–û–° –°–¢–†–û–ö–ò -->
    {% macro render_row(calc) %}
    <tr class="hover:bg-mono-bg transition group cursor-pointer border-b border-mono-border last:border-0 filter-row" 
        onclick="window.location='/admin/calculator/{{ calc.id }}'"
        data-route="{{ calc.title }} {{ calc.station_from }} {{ calc.station_to }}"
        data-provider="{{ calc.service_provider }}"
        data-type="{{ calc.container_type }}">
        
        <!-- –ß–µ–∫–±–æ–∫—Å –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π -->
        <td class="px-3 py-4 text-center align-middle border-r border-mono-border/50" onclick="event.stopPropagation()">
            <input type="checkbox" name="selected_calc" value="{{ calc.id }}" onchange="updateFloatingBar()"
                   class="calc-checkbox w-4 h-4 rounded border-gray-300 text-mono-black focus:ring-mono-black cursor-pointer">
        </td>

        <!-- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ -->
        <td class="px-6 py-4">
            <div class="font-bold text-mono-black text-sm">{{ calc.title }}</div>
            <div class="text-xs text-mono-gray mt-0.5 font-mono flex items-center gap-1">
                {{ calc.station_from }} 
                <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                {{ calc.station_to }}
            </div>
        </td>
        
        <!-- –ü–æ—Å—Ç–∞–≤—â–∏–∫ -->
        <td class="px-6 py-4">
            <span class="inline-flex items-center px-2.5 py-1 rounded-lg bg-white text-xs font-bold text-mono-black border border-mono-border whitespace-nowrap shadow-sm">
                {{ calc.service_provider }}
            </span>
        </td>

        <!-- –¢–∏–ø –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
        <td class="px-6 py-4">
            <span class="inline-flex items-center px-2.5 py-1 rounded border border-mono-border bg-mono-bg text-xs font-medium text-mono-black whitespace-nowrap">
                {% if calc.container_type == '20_REF' %} 20' –õ–µ–≥–∫–∞—è
                {% elif calc.container_type == '20_HEAVY' %} 20' –¢—è–∂–µ–ª–∞—è
                {% elif calc.container_type == '20_EXTRA' %} 20' –≠–∫—Å—Ç—Ä–∞
                {% elif calc.container_type == '40_STD' %} 40' –õ–µ–≥–∫–∞—è
                {% elif calc.container_type == '40_HEAVY' %} 40' –¢—è–∂–µ–ª–∞—è
                {% else %} {{ calc.container_type.replace('_', "' ") }} {% endif %}
                <span class="text-mono-gray ml-1 opacity-50">/ {{ "–ü–í" if calc.wagon_type.value == 'GONDOLA' else "–§–ò–¢" }}</span>
            </span>
        </td>

        <!-- –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å -->
        <td class="px-6 py-4 text-right">
            <div class="font-medium text-mono-gray text-xs font-mono">
                {{ "{:,.0f}".format(calc.total_cost * (1 + calc.vat_rate/100)).replace(',', ' ') }} ‚ÇΩ
            </div>
        </td>

        <!-- –ò—Ç–æ–≥–æ -->
        <td class="px-6 py-4 text-right">
            <div class="font-bold text-mono-black text-sm font-mono">
                {{ "{:,.0f}".format(((calc.total_price_netto * (1 + calc.vat_rate/100)) / 1000) | round(0, 'ceil') * 1000).replace(',', ' ') }} ‚ÇΩ
            </div>
        </td>

        <!-- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è -->
        <td class="px-6 py-4 text-center whitespace-nowrap">
            {% if calc.valid_to %}
                {% if today and calc.valid_to < today %}
                    <span class="text-[10px] font-bold text-red-500 bg-red-50 px-2 py-1 rounded border border-red-100">
                        –ò—Å—Ç–µ–∫ {{ calc.valid_to.strftime('%d.%m') }}
                    </span>
                {% else %}
                    <span class="text-xs font-mono text-mono-gray">
                        –¥–æ {{ calc.valid_to.strftime('%d.%m.%Y') }}
                    </span>
                {% endif %}
            {% else %}
                <span class="text-xs text-gray-300">‚Äî</span>
            {% endif %}
        </td>

        <!-- –°—Ç–∞—Ç—É—Å –∏ –î–µ–π—Å—Ç–≤–∏—è -->
        <td class="px-6 py-4 text-right">
            <div class="flex items-center justify-end gap-2">
                {% if calc.status.value == 'DRAFT' %}
                    <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">–ß–µ—Ä–Ω–æ–≤–∏–∫</span>
                {% elif calc.status.value == 'PUBLISHED' %}
                    <span class="bg-[#39ff14]/10 text-[#008000] border border-[#39ff14]/50 shadow-[0_0_8px_rgba(57,255,20,0.3)] px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">
                        –ê–ö–¢–ò–í–ï–ù
                    </span>
                {% else %}
                    <span class="text-gray-400 text-[10px] uppercase font-bold">–ê—Ä—Ö–∏–≤</span>
                {% endif %}
                
                <div class="w-px h-4 bg-mono-border mx-2"></div>

                <!-- –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å -->
                <form action="/admin/calculator/{{ calc.id }}/copy" method="POST" class="inline-block" onsubmit="event.stopPropagation()">
                    <button type="submit" class="p-1.5 text-mono-gray hover:text-mono-black hover:bg-white border border-transparent hover:border-mono-border rounded-lg transition shadow-sm group" title="–°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é" onclick="event.stopPropagation()">
                        <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path></svg>
                    </button>
                </form>

                <!-- –£–¥–∞–ª–∏—Ç—å -->
                <form action="/admin/calculator/{{ calc.id }}/delete" method="POST" class="inline-block">
                    <button type="submit" class="p-1.5 text-mono-gray hover:text-red-600 hover:bg-red-50 border border-transparent hover:border-red-100 rounded-lg transition shadow-sm group" title="–£–¥–∞–ª–∏—Ç—å" onclick="event.stopPropagation(); return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞—Å—á–µ—Ç?');">
                        <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </form>
            </div>
        </td>
    </tr>
    {% endmacro %}

    <!-- –¢–ê–ë–õ–ò–¶–ê -->
    <div class="bg-white rounded-2xl shadow-card border border-transparent overflow-hidden mb-24">
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left border-collapse" id="calcTable">
                <thead class="bg-mono-bg text-mono-gray text-[10px] uppercase font-bold tracking-wider">
                    <!-- –ó–ê–ì–û–õ–û–í–ö–ò -->
                    <tr>
                        <th class="px-3 py-3 w-[30px] text-center border-r border-mono-border/50">
                            <input type="checkbox" id="selectAll" onclick="toggleAll(this)" 
                                   class="w-3.5 h-3.5 rounded border-gray-300 text-mono-black focus:ring-mono-black cursor-pointer">
                        </th>
                        <th class="px-6 pt-4 pb-2 w-1/3">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ / –ú–∞—Ä—à—Ä—É—Ç</th>
                        <th class="px-6 pt-4 pb-2">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                        <th class="px-6 pt-4 pb-2">–¢–∏–ø</th>
                        <th class="px-6 pt-4 pb-2 text-right whitespace-nowrap">–°–µ–±–µ—Å—Ç. (—Å –ù–î–°)</th>
                        <th class="px-6 pt-4 pb-2 text-right whitespace-nowrap">–ò—Ç–æ–≥–æ (—Å –ù–î–°)</th>
                        <th class="px-6 pt-4 pb-2 text-center">–°—Ä–æ–∫</th>
                        <th class="px-6 pt-4 pb-2 text-right">–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                    <!-- –°–¢–†–û–ö–ê –§–ò–õ–¨–¢–†–û–í -->
                    <tr class="bg-mono-bg border-b border-mono-border">
                        <th class="px-3 py-2 border-r border-mono-border/50"></th>
                        <th class="px-6 pb-4 pt-1">
                            <input type="text" id="filterRoute" onkeyup="filterTable()" placeholder="–ü–æ–∏—Å–∫..." 
                                   class="w-full px-3 py-1.5 rounded-lg border-none bg-white text-xs text-mono-black focus:ring-2 focus:ring-mono-black/10 placeholder-gray-400 outline-none transition shadow-sm">
                        </th>
                        <th class="px-6 pb-4 pt-1">
                            <input type="text" id="filterProvider" onkeyup="filterTable()" placeholder="–í—Å–µ" 
                                   class="w-full px-3 py-1.5 rounded-lg border-none bg-white text-xs text-mono-black focus:ring-2 focus:ring-mono-black/10 placeholder-gray-400 outline-none transition shadow-sm">
                        </th>
                        <th class="px-6 pb-4 pt-1">
                            <input type="text" id="filterType" onkeyup="filterTable()" placeholder="–í—Å–µ" 
                                   class="w-full px-3 py-1.5 rounded-lg border-none bg-white text-xs text-mono-black focus:ring-2 focus:ring-mono-black/10 placeholder-gray-400 outline-none transition shadow-sm">
                        </th>
                        <th colspan="4" class="px-6 pb-4 pt-1"></th>
                    </tr>
                </thead>
                
                <tbody class="divide-y divide-mono-border">
                    {% if calculations %}
                        {# –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ê–Ø –ì–†–£–ü–ü–ò–†–û–í–ö–ê #}
                        {% set groupby_field = 'station_to' if current_type == 'SINGLE' else 'service_provider' %}
                        
                        {% for group in calculations|groupby(groupby_field) %}
                            
                            <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –≥—Ä—É–ø–ø—ã -->
                            <tr class="bg-mono-bg/30 border-t-2 border-mono-border group-header" data-group-name="{{ group.grouper }}">
                                <td colspan="8" class="px-6 py-2.5">
                                    <div class="flex items-center gap-3">
                                        <div class="w-2 h-2 rounded-full bg-mono-black"></div>
                                        {% if current_type == 'SINGLE' %}
                                            <span class="text-xs font-bold text-mono-gray uppercase tracking-wide">–°—Ç–∞–Ω—Ü–∏—è:</span>
                                        {% else %}
                                            <span class="text-xs font-bold text-mono-gray uppercase tracking-wide">–ü–æ—Å—Ç–∞–≤—â–∏–∫:</span>
                                        {% endif %}
                                        <span class="text-sm font-extrabold text-mono-black tracking-wide uppercase">{{ group.grouper }}</span>
                                    </div>
                                </td>
                            </tr>
                            
                            <!-- –î–∞–Ω–Ω—ã–µ –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã -->
                            {% set priority_order = ['40_STD', '40_HEAVY', '20_REF', '20_HEAVY', '20_EXTRA'] %}
                            {% for type_code in priority_order %}
                                {% for calc in group.list if calc.container_type == type_code %}{{ render_row(calc) }}{% endfor %}
                            {% endfor %}
                            {% for calc in group.list if calc.container_type not in priority_order %}{{ render_row(calc) }}{% endfor %}
                        
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="px-6 py-16 text-center">
                                <div class="flex flex-col items-center justify-center text-mono-gray">
                                    <svg class="w-12 h-12 mb-3 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    <p class="font-medium">–ù–µ—Ç —Ä–∞—Å—á–µ—Ç–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "{{ '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã–µ –ø–æ–µ–∑–¥–∞' if current_type == 'TRAIN' else '–í–∞–≥–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞' }}"</p>
                                    <a href="/admin/calculator/new?type={{ current_type }}" class="mt-4 text-sm text-mono-black font-bold border-b border-mono-black hover:opacity-70 transition">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ä–∞—Å—á–µ—Ç</a>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ó–ê–ì–†–£–ó–ö–ò –¢–ê–†–ò–§–û–í (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
<div id="tariffModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-gray-100 animate-slide-up">
                <div class="bg-white px-6 py-5 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="text-lg font-bold leading-6 text-mono-black" id="modal-title">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ –ñ–î</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 outline-none p-1 rounded-lg hover:bg-gray-100 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <form action="/admin/tariffs/upload" method="POST" enctype="multipart/form-data" id="uploadForm" onsubmit="showLoading()">
                    <div class="px-6 py-6">
                        <div class="relative border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-green-500 hover:bg-green-50 transition-all cursor-pointer group" id="drop-zone">
                            <input type="file" name="file" id="file-upload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx, .xls" required onchange="updateFileName(this)">
                            <div class="space-y-4 pointer-events-none" id="upload-content">
                                <div class="mx-auto w-14 h-14 bg-gray-50 rounded-full flex items-center justify-center group-hover:bg-white group-hover:shadow-md transition">
                                    <svg class="w-7 h-7 text-gray-400 group-hover:text-green-600 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-mono-black mb-1" id="file-label">
                                        –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª Excel
                                    </div>
                                    <p class="text-xs text-gray-500">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                                </div>
                            </div>
                            <div id="upload-spinner" class="hidden flex-col items-center justify-center py-4">
                                <svg class="animate-spin h-8 w-8 text-mono-black mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span class="text-sm font-bold text-mono-black">–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...</span>
                                <span class="text-xs text-gray-500 mt-1">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</span>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center justify-between text-[10px] text-gray-400 px-1">
                            <span>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è .xlsx</span>
                            <span>–†–∞–∑–º–µ—Ä –¥–æ 10 –ú–ë</span>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-6 py-4 flex flex-col sm:flex-row-reverse gap-3 rounded-b-2xl border-t border-gray-100">
                        <button type="submit" id="submit-btn" class="w-full sm:w-auto inline-flex justify-center rounded-xl bg-mono-black px-6 py-2.5 text-sm font-bold text-white shadow-sm hover:bg-gray-800 transition active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                            –ó–∞–≥—Ä—É–∑–∏—Ç—å
                        </button>
                        <button type="button" class="w-full sm:w-auto mt-3 sm:mt-0 inline-flex justify-center rounded-xl bg-white px-6 py-2.5 text-sm font-bold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 transition active:scale-95" onclick="closeModal()">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- üî• –ü–õ–ê–í–ê–Æ–©–ê–Ø –ü–ê–ù–ï–õ–¨ –î–ï–ô–°–¢–í–ò–ô (–û–ë–ù–û–í–õ–ï–ù–ê) -->
<div id="floatingAction" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-mono-black text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-4 z-50 transition-all duration-300 transform translate-y-32 opacity-0">
    <div class="flex items-center gap-2">
        <span class="bg-white/20 text-xs font-bold px-2 py-1 rounded" id="selectedCount">0</span>
        <span class="text-sm font-medium">–≤—ã–±—Ä–∞–Ω–æ</span>
    </div>
    <div class="h-4 w-px bg-white/20"></div>
    
    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <button onclick="submitBatchAction('ARCHIVED')" class="flex items-center gap-2 hover:opacity-80 transition font-bold text-xs bg-gray-700 px-3 py-1.5 rounded-lg">
        –í –ê—Ä—Ö–∏–≤
    </button>
    <button onclick="submitBatchAction('PUBLISHED')" class="flex items-center gap-2 hover:opacity-80 transition font-bold text-xs bg-green-700 px-3 py-1.5 rounded-lg">
        –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
    </button>
    <button onclick="submitBatchAction('DRAFT')" class="flex items-center gap-2 hover:opacity-80 transition font-bold text-xs bg-gray-600 px-3 py-1.5 rounded-lg">
        –í –ß–µ—Ä–Ω–æ–≤–∏–∫
    </button>

    <!-- Date Batch Action -->
    <div class="h-4 w-px bg-white/20 mx-2"></div>
    <div class="flex items-center gap-1 bg-white/10 rounded-lg p-1 ml-2">
        <input type="text" id="batchDateInput" placeholder="–£—Å—Ç. —Å—Ä–æ–∫" 
               class="bg-transparent border-none text-white text-xs w-24 text-center focus:ring-0 placeholder-white/50 cursor-pointer batch-datepicker">
        <button onclick="submitBatchDate()" class="bg-white text-mono-black hover:bg-gray-200 px-2 py-1 rounded-md text-xs font-bold transition" title="–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ä–æ–∫">
            OK
        </button>
    </div>
</div>

<!-- –°–ö–†–´–¢–ê–Ø –§–û–†–ú–ê –î–õ–Ø –ú–ê–°–°–û–í–´–• –î–ï–ô–°–¢–í–ò–ô (–°–¢–ê–¢–£–°) -->
<form id="batchActionForm" action="/admin/calculator/batch_status" method="POST" class="hidden">
    <input type="hidden" name="data_json" id="batchActionData">
</form>

<!-- –°–ö–†–´–¢–ê–Ø –§–û–†–ú–ê –î–õ–Ø –ú–ê–°–°–û–í–´–• –î–ï–ô–°–¢–í–ò–ô (–î–ê–¢–ê) -->
<form id="batchDateForm" action="/admin/calculator/batch_date" method="POST" class="hidden">
    <input type="hidden" name="data_json" id="batchDateData">
</form>

<script>
    const modal = document.getElementById('tariffModal');
    const dropZone = document.getElementById('drop-zone');
    const spinner = document.getElementById('upload-spinner');
    const content = document.getElementById('upload-content');
    const submitBtn = document.getElementById('submit-btn');
    const label = document.getElementById('file-label');

    function openModal() { modal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
    function closeModal() { modal.classList.add('hidden'); document.body.style.overflow = ''; document.getElementById('uploadForm').reset(); resetUI(); }
    function updateFileName(input) { if (input.files.length > 0) { label.textContent = input.files[0].name; label.classList.add('text-green-600'); dropZone.classList.add('border-green-500', 'bg-green-50'); dropZone.classList.remove('border-gray-300'); } else { resetUI(); } }
    function resetUI() { label.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª Excel'; label.classList.remove('text-green-600'); dropZone.classList.remove('border-green-500', 'bg-green-50'); dropZone.classList.add('border-gray-300'); spinner.classList.add('hidden'); content.classList.remove('hidden'); submitBtn.disabled = false; submitBtn.innerText = '–ó–∞–≥—Ä—É–∑–∏—Ç—å'; }
    function showLoading() { content.classList.add('hidden'); spinner.classList.remove('hidden'); submitBtn.disabled = true; submitBtn.innerText = '–ó–∞–≥—Ä—É–∑–∫–∞...'; }
    document.addEventListener('keydown', function(event) { if (event.key === "Escape" && !modal.classList.contains('hidden')) { closeModal(); } });

    document.addEventListener("DOMContentLoaded", function() {
        flatpickr(".batch-datepicker", {
            locale: "ru",
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "d.m.Y",
            disableMobile: "true",
            position: "auto center"
        });
    });

    // --- –õ–û–ì–ò–ö–ê –ú–ê–°–°–û–í–´–• –î–ï–ô–°–¢–í–ò–ô ---
    
    function toggleAll(source) {
        const checkboxes = document.querySelectorAll('.calc-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = source.checked;
        });
        updateFloatingBar();
    }

    function updateFloatingBar() {
        const checkedBoxes = document.querySelectorAll('.calc-checkbox:checked');
        const bar = document.getElementById('floatingAction');
        const countSpan = document.getElementById('selectedCount');
        
        countSpan.innerText = checkedBoxes.length;

        if (checkedBoxes.length > 0) {
            bar.classList.remove('translate-y-32', 'opacity-0');
        } else {
            bar.classList.add('translate-y-32', 'opacity-0');
            document.getElementById('selectAll').checked = false;
        }
    }

    function submitBatchAction(status) {
        const checkedBoxes = document.querySelectorAll('.calc-checkbox:checked');
        const ids = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
        
        if (ids.length === 0) return;

        const jsonField = document.getElementById('batchActionData');
        jsonField.value = JSON.stringify({ids: ids, status: status});
        
        document.getElementById('batchActionForm').submit();
    }

    function submitBatchDate() {
        const checkedBoxes = document.querySelectorAll('.calc-checkbox:checked');
        const ids = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
        
        // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ input'–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç flatpickr (–∏–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ, –µ—Å–ª–∏ altInput=false)
        // –ù–æ –ø—Ä–∏ altInput=true, flatpickr –ø–∏—à–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∏—Å—Ö–æ–¥–Ω—ã–π input
        const dateVal = document.getElementById('batchDateInput').value; 
        
        if (ids.length === 0) return;
        
        const jsonField = document.getElementById('batchDateData');
        jsonField.value = JSON.stringify({ids: ids, date: dateVal});
        
        document.getElementById('batchDateForm').submit();
    }

    // üî• –°–ö–†–ò–ü–¢ –§–ò–õ–¨–¢–†–ê–¶–ò–ò üî•
    function filterTable() {
        const routeFilter = document.getElementById('filterRoute').value.toLowerCase();
        const providerFilter = document.getElementById('filterProvider').value.toLowerCase();
        const typeFilter = document.getElementById('filterType').value.toLowerCase();
        
        const rows = document.querySelectorAll('tr.filter-row');
        const groupHeaders = document.querySelectorAll('tr.group-header');
        
        let groupsVisibility = new Map();
        groupHeaders.forEach(header => groupsVisibility.set(header, false));

        rows.forEach(row => {
            const route = row.getAttribute('data-route').toLowerCase();
            const provider = row.getAttribute('data-provider').toLowerCase();
            const type = row.getAttribute('data-type').toLowerCase();
            
            const matchRoute = route.includes(routeFilter);
            const matchProvider = provider.includes(providerFilter);
            const matchType = type.includes(typeFilter);
            
            if (matchRoute && matchProvider && matchType) {
                row.style.display = '';
                let prev = row.previousElementSibling;
                while (prev) {
                    if (prev.classList.contains('group-header')) {
                        groupsVisibility.set(prev, true);
                        break;
                    }
                    prev = prev.previousElementSibling;
                }
            } else {
                row.style.display = 'none';
            }
        });
        
        groupsVisibility.forEach((isVisible, header) => {
            header.style.display = isVisible ? '' : 'none';
        });
    }
</script>
{% endblock %}